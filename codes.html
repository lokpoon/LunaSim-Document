
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Codes &#8212; MoonShine Instruction Manual</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="References" href="reference.html" />
    <link rel="prev" title="Download files" href="download.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">MoonShine Instruction Manual</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="overview.html">
                    Overview
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="lux_calculator.html">
   1.
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Lux calculator
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="moonlight_LED_scheduler.html">
   2.
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Moonlight scheduler
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="sunlight_twilight_LED_scheduler.html">
   3.
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Sunlight/twilight scheduler
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="edit_LED_schedule_csv.html">
   4. Edit LED schedule
   <code class="docutils literal notranslate">
    <span class="pre">
     .csv
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="moonshine_hardware_setup.html">
   5.
   <span style="font-variant:small-caps;">
    MoonShineP
   </span>
   : Hardware setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="moonshine_software_setup.html">
   6.
   <span style="font-variant:small-caps;">
    MoonShineP
   </span>
   : Software setup
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="moonshine_calibration.html">
   7.
   <span style="font-variant:small-caps;">
    MoonShineP
   </span>
   : Calibration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="moonshine_launch_procedure.html">
   8.
   <span style="font-variant:small-caps;">
    MoonShineP
   </span>
   : Launch procedure
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="download.html">
   Download files
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Codes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="reference.html">
   References
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/Crampton-Lab/MoonShine/master?urlpath=tree/docs/codes.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/Crampton-Lab/MoonShine"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/Crampton-Lab/MoonShine/issues/new?title=Issue%20on%20page%20%2Fcodes.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/codes.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download notebook file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        <a href="_sources/codes.md"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.md</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshiner-span-lux-calculator">
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Lux calculator
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshiner-span-moonlight-scheduler">
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Moonlight scheduler
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshiner-span-sunlight-twilight-scheduler">
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Sunlight/twilight scheduler
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshinep-span-moonshine-moon-py">
   <span style="font-variant:small-caps;">
    MoonShineP
   </span>
   :
   <code class="docutils literal notranslate">
    <span class="pre">
     moonshine_moon.py
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshinep-span-moonshine-sun-py">
   <span style="font-variant:small-caps;">
    MoonShineP
   </span>
   :
   <code class="docutils literal notranslate">
    <span class="pre">
     moonshine_sun.py
    </span>
   </code>
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Codes</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshiner-span-lux-calculator">
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Lux calculator
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshiner-span-moonlight-scheduler">
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Moonlight scheduler
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshiner-span-sunlight-twilight-scheduler">
   <span style="font-variant:small-caps;">
    MoonShineR
   </span>
   : Sunlight/twilight scheduler
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshinep-span-moonshine-moon-py">
   <span style="font-variant:small-caps;">
    MoonShineP
   </span>
   :
   <code class="docutils literal notranslate">
    <span class="pre">
     moonshine_moon.py
    </span>
   </code>
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#span-style-font-variant-small-caps-moonshinep-span-moonshine-sun-py">
   <span style="font-variant:small-caps;">
    MoonShineP
   </span>
   :
   <code class="docutils literal notranslate">
    <span class="pre">
     moonshine_sun.py
    </span>
   </code>
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="codes">
<span id="content-codes"></span><h1>Codes<a class="headerlink" href="#codes" title="Permalink to this headline">#</a></h1>
<ul class="simple">
<li><p>The <em><span style="font-variant:small-caps;">MoonShineR</span></em> and <em><span style="font-variant:small-caps;">MoonShineP</span></em> codes are provided here for the manuscript review process. Users should just download them from our GitHub repository.</p></li>
</ul>
<section id="span-style-font-variant-small-caps-moonshiner-span-lux-calculator">
<h2><span style="font-variant:small-caps;">MoonShineR</span>: Lux calculator<a class="headerlink" href="#span-style-font-variant-small-caps-moonshiner-span-lux-calculator" title="Permalink to this headline">#</a></h2>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># MoonShineR - Lux calculator</span>
<span class="c1"># An R program by C. Lok Poon, Crampton Electric Fish Lab, University of Central Florida, Copyright 2023</span>
<span class="c1"># A detailed guide about this program: https://lokpoon.github.io/moonshine_manual/lux_calculator.html</span>

<span class="c1"># Description:</span>
<span class="c1"># This script predicts accurate moonlight illuminance at a given geographical location and time period. It generate a lux_calculator_output.csv and .png plot.</span>

<span class="c1"># Load libraries ---------------------------</span>

<span class="nf">library</span><span class="p">(</span><span class="n">suncalc</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rpmodel</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">REdaS</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">npreg</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">beepr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>

<span class="c1">#---------------------------START OF PARAMETER SETTINGS---------------------------</span>

<span class="c1"># (!) indicates a user specified setting</span>

<span class="c1"># Set working directory:</span>
<span class="nf">setwd</span><span class="p">(</span><span class="s">&quot;/Users/lokpoon/Desktop&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1"># (!) Set working directory. .csv and .png files will be saved to this directory</span>

<span class="c1"># Set the location and time ---------------------------</span>
<span class="n">latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-4.21528</span><span class="w"> </span><span class="c1"># (!) Latitude in decimal degrees (e.g., -4.21528)</span>
<span class="n">longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-69.94056</span><span class="w"> </span><span class="c1"># (!) Longitude in decimal degrees (e.g., -69.94056)</span>
<span class="n">site_elev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1"># (!) site elevation in meter (e.g., 0 = sea level). Elevation correction only applies to moonlight but not sunlight and twilight.</span>
<span class="c1"># The user can determine the site elevation of a coordinate location using https://www.dcode.fr/earth-elevation</span>

<span class="n">time_zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;EST&quot;</span><span class="w"> </span><span class="c1"># (!) Set the time zone for the location set (e.g., “EST”). REMEMBER TO CHANGE THE TIME ZONE WHEN THE LOCATION IS CHANGED.</span>
<span class="c1">## Enter the following text R console for a list of the time zone name: OlsonNames(tzdir = NULL)</span>
<span class="c1">## Use a time zone without DST. E.g., use &quot;EST&quot; instead of &quot;America/New_York&quot;</span>
<span class="n">date_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;2023-03-01&quot;</span><span class="w"> </span><span class="c1"># (!) Starting date of the simulation (YYYY-MM-DD)</span>
<span class="n">time_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;18:00:00&quot;</span><span class="w"> </span><span class="c1"># (!) Starting date of the simulation (hh:mm:ss)</span>
<span class="n">duration_day</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># (!) Duration of simulation in days</span>
<span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># (!) The temporal resolution of the simulation in minutes. E.g., 5 = calculates the illuminance every 5 minutes.</span>
<span class="c1">## User may increase time_interval_minutes for a shorter run time when simulating over many days.</span>

<span class="c1"># Set nominal dark sky value ---------------------------</span>
<span class="c1">## Adding a baseline illumination to the model to represent other nocturnal light sources (e.g., starlight and airglow) (Hänel et al. 2017) </span>
<span class="n">darksky_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.0008</span><span class="w"> </span><span class="c1"># (!) Choose from between 0.0006 to 0.0009. Default = 0.0008</span>
<span class="c1">## change it to zero if a completely dark sky is preferred.</span>

<span class="c1"># Set what type of illuminance to plot ---------------------------</span>
<span class="n">illuminance_type_plot</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;moon_final_lux_nighttime&quot;</span><span class="w"> </span><span class="c1"># (!) Enter one of the below illuminance column names.</span>
<span class="c1">## This only affect the plot, the .csv output will include all of the various illuminance columns.</span>

<span class="c1"># Illuminance columns name:</span>
<span class="c1"># moon_final_lux = illuminance of moonlight (plus the darksky_value)</span>
<span class="c1"># moon_final_lux_nighttime = illuminance of moonlight only at night (reports NA at daytime, when sun altitude &gt; 0 degrees)</span>
<span class="c1"># twilight = illuminance of twilight (defined as the light when sun altitude &lt; 0 degrees)</span>
<span class="c1"># sunlight = illuminance of sunlight (defined as the light when sun altitude &gt; 0 degrees)</span>
<span class="c1"># total_illuminance_all = sum of moonlight, twilight, and sunlight</span>
<span class="c1"># sunlight_twilight = sum of sunlight and twilight</span>
<span class="c1"># moonlight_twilight_nighttime = illuminance of moonlight plus twilight only at night (reports NA at daytime, when sun altitude &gt; 0 degrees)</span>

<span class="c1"># To generate a good-looking plot, the user will typically need to modify the y-axis range. See the plotting section near the end.</span>
<span class="w">  </span>
<span class="c1">#---------------------------END OF PARAMETER SETTINGS---------------------------</span>

<span class="c1">#---------------------------START OF ILLUMINATION COMPUTATION-------------------</span>

<span class="c1"># Start time formatting</span>
<span class="n">date_time_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">time_start</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>
<span class="n">number_of_interval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">ddays</span><span class="p">(</span><span class="n">duration_day</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">))</span>

<span class="c1"># Create an empty dataframe, to be filled during for loop</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number_of_interval</span><span class="p">))</span>
<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>

<span class="c1"># Create for loop [i] time interval list</span>
<span class="n">time_interval_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_interval</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span>

<span class="c1"># Create a progress bar object</span>
<span class="n">pb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">progress_bar</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">time_interval_list</span><span class="p">))</span>

<span class="c1"># Fill in empty data frame with suncalc data</span>
<span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">time_interval_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;datetime&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;date&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;phase_angle&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;phase&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">-360</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">180</span><span class="w"> </span><span class="c1"># phase_angle = angular separation of the sun and Earth, as seen on the moon</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fraction&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="o">*</span><span class="m">60</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fraction&quot;</span><span class="p">])</span><span class="w"> </span><span class="c1"># Moon illuminated fraction, not used in calculation. This is calculated only for user to learn about the moon phase.</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Z_moon&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="nf">rad2deg</span><span class="p">(</span><span class="nf">getMoonPosition</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longitude</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;altitude&quot;</span><span class="p">]))</span><span class="w"> </span><span class="c1"># Z_moon = Zenith distance in degree of the moon = 90 - moon altitude</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;distance&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getMoonPosition</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longitude</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;distance&quot;</span><span class="p">]</span><span class="w"> </span><span class="c1"># distance = moon/Earth distance in km</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sun_altitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rad2deg</span><span class="p">(</span><span class="nf">getSunlightPosition</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;altitude&quot;</span><span class="p">))[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;altitude&quot;</span><span class="p">])</span><span class="w"> </span><span class="c1"># sun_altitude = altitude of the sun in degree</span>
<span class="w">  </span><span class="n">pb</span><span class="o">$</span><span class="nf">tick</span><span class="p">()</span><span class="w"> </span><span class="c1"># Update the progress bar</span>
<span class="p">}</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># Replace moon altitude that are lower than horizon_elev with NA (moon below horizon)</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">Z_moon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">Z_moon</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">Z_moon</span><span class="p">))</span><span class="w"> </span>

<span class="c1"># Calculate atmospheric extinction</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="m">-0.140194</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">Z_moon</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">-91.674385</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">Z_moon</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">0.03</span><span class="w"> </span><span class="c1"># A Michaelis-Menten that fits Table 2 in Austin et al. (1976)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="p">)</span>

<span class="c1"># Moon magnitude calculated from phase angle (unit in relative magnitude) (see Allen 1976, p. 144)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="m">-12.73</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.026</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">-9</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>

<span class="c1"># Initial illuminance of moonlight (see eq. (16) of Schaefer 1990a)</span>
<span class="n">illuminance_temp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">((</span><span class="m">-0.4</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">16.57</span><span class="p">))</span><span class="w"> </span><span class="c1"># In unit foot candle</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">illuminance_temp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">10.7639</span><span class="w"> </span><span class="c1"># Convert to lux</span>

<span class="c1"># Correct for the effect of site elevation</span>
<span class="n">atm_pressure_relative_to_sea</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">patm</span><span class="p">(</span><span class="n">site_elev</span><span class="p">,</span><span class="w"> </span><span class="n">patm0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">101325</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">101325</span><span class="w"> </span><span class="c1"># The atmospheric pressure at the site elevation relative to sea level</span>
<span class="n">sea_555nm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">18.964</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">-0.229</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1"># Sea level irradiance at 555nm. Function extracted from figure 1 of Laue (1970)</span>
<span class="n">elevated_555nm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">18.964</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">-0.229</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">atm_pressure_relative_to_sea</span><span class="p">)</span><span class="w"> </span><span class="c1"># Sea level irradiance at 555nm. Function extracted from figure 1 of Laue (1970)</span>
<span class="n">increase_factor_elev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">elevated_555nm</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sea_555nm</span><span class="w"> </span><span class="c1"># relative increase in illuminance due to elevation</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">increase_factor_elev</span>

<span class="c1"># Apply lunar opposition surge when p &lt; 6 (Buratti et al. 1996, figure 5)</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="m">0.4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="n">phase_angle</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="p">),</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="p">))</span>
<span class="c1">## A linear increase in moon brightness as phase angle decreases below 6</span>

<span class="c1"># Apply spreading out effect (angle of incidence) of light when illuminating at an angle (Austin et al. 1976)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sin</span><span class="p">(</span><span class="nf">deg2rad</span><span class="p">(</span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">Z_moon</span><span class="p">))</span>

<span class="c1"># The moon/Earth distance effect (inverse square law) (Austin et al. 1976)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">distance</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">384400</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">))</span>

<span class="c1"># Waxing Waning asymmetric effect (simplified function derived from Austin et al. 1976 Table 1)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">-0.00026</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">),</span>
<span class="w">                                          </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="p">)</span>

<span class="c1"># Final moonlight illuminance (with a slight adjustment factor, calibrated from Leticia, Colombia, Aug 11, 2022 field full moon measurement)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.863</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">darksky_value</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="p">,</span><span class="w"> </span><span class="nf">is.na</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="p">),</span><span class="w"> </span><span class="n">darksky_value</span><span class="p">)</span><span class="w"> </span><span class="c1"># Replace NA with darksky_value</span>

<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">moon_final_lux_nighttime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">moon_final_lux</span><span class="p">))</span><span class="w"> </span><span class="c1"># Create moon_final_lux_nighttime column</span>

<span class="c1">#---------------------------TWILIGHT CALCULATION---------------------------</span>

<span class="c1"># Calculation of sunlight and twilight follows Seidelmann (1992)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-0.8</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">2.88</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">22.26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">207.64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1034.3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="p">)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-0.8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-5</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">2.88</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">21.81</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">258.11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">858.36</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="p">)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-12</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">2.7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">12.17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">431.69</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1899.83</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="p">)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-12</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-18</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">13.84</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">262.72</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1447.42</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2797.93</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="p">)</span>

<span class="c1">#---------------------------SUNLIGHT (SUN &gt; 0 DEGREE) CALCULATION---------------------------</span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">20</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">3.74</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">3.97</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">4.07</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.47</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="p">)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">3.05</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">13.28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">45.98</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">64.33</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="p">)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">2.88</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">22.26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">207.64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1034.3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="p">)</span>

<span class="c1">#---------------------------ADD MOON, SUNLIGHT AND TWILIGHT TOGETHER---------------------------</span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">total_illuminance_all</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight_twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sunlight</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moonlight_twilight_nighttime</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux_nighttime</span>

<span class="c1">#---------------------------REMOVE UNNECESSARY COLUMNS---------------------------</span>

<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">atm_ext</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="p">))</span>

<span class="c1">#---------------------------END OF ILLUMINATION COMPUTATION--------------------</span>

<span class="c1">#---------------------------GENERATE lux_calculator_output.csv---------------------------</span>

<span class="c1"># Save moon table csv file</span>
<span class="nf">write.csv</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="s">&quot;lux_calculator_output.csv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Explanation for the columns found in lux_calculator_output.csv:</span>
<span class="c1"># Use whichever illuminance prediction is appropriate for desired use. </span>

<span class="c1">## datetime = The datetime in a standard format that R and moonshine_moon.py can read</span>
<span class="c1">## phase_angle = the phase angle of the moon</span>
<span class="c1">## fraction = the illuminated fraction of the moon</span>
<span class="c1">## Z_moon = zenith distance of the moon in degree angle</span>
<span class="c1">## distance = the moon and Earth distance in km</span>
<span class="c1">## sun_altitude = The altitude of the sun. Positive/negative value means the sun is above/below the horizon, respectively.</span>
<span class="c1">## moon_final_lux = illuminance of moonlight (plus the darksky_value)</span>
<span class="c1">## moon_final_lux_nighttime = illuminance of moonlight only at night (reports NA at daytime, when sun altitude &gt; 0 degree)</span>
<span class="c1">## twilight = illuminance of twilight (defined as the light when sun altitude &lt; 0 degree</span>
<span class="c1">## sunlight = illuminance of sunlight (defined as the light when sun altitude &gt; 0 degree)</span>
<span class="c1">## total_illuminance_all = sum of moonlight, twilight, and sunlight</span>
<span class="c1">## sunlight_twilight = sum of sunlight and twilight</span>
<span class="c1">## moonlight_twilight_nighttime = illuminance of moonlight plus twilight only at night (reports NA at daytime, when sun altitude &gt; 0 degree)</span>

<span class="c1">#---------------------------Plotting Section---------------------------</span>

<span class="n">plot_option</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="c1"># (!) FALSE to turn off plotting</span>

<span class="c1"># Dark gray area depicts dark periods (true night after astronomical twilight ended).</span>
<span class="c1"># Light gray area indicate the periods of astronomical twilight.</span>

<span class="c1"># Create a clean ggplot theme</span>
<span class="n">theme_rectangular_clean</span><span class="w"> </span><span class="o">&lt;-</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unit</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s">&quot;cm&quot;</span><span class="p">))</span>

<span class="c1"># Specify the time of night period and twilight period for shading</span>
<span class="n">night_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">night_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">night_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>

<span class="n">after_twilight_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="m">-18</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">after_twilight_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">after_twilight_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">time_zone</span><span class="p">)</span>

<span class="n">day_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">day_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">day_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>

<span class="c1"># Plotting:</span>
<span class="n">plot_output</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_rectangular_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">night_time</span><span class="p">,</span><span class="w"> </span><span class="c1"># night period</span>
<span class="w">                </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">night_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">),</span>
<span class="w">                </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey88&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">after_twilight_time</span><span class="p">,</span><span class="w"> </span><span class="c1"># after twilight</span>
<span class="w">                </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">after_twilight_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">),</span>
<span class="w">                </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey80&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">eval</span><span class="p">(</span><span class="nf">as.symbol</span><span class="p">(</span><span class="n">illuminance_type_plot</span><span class="p">))),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.75</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">day_time</span><span class="p">,</span><span class="w"> </span><span class="c1"># day time mask moonlight regression to gray color</span>
<span class="w">                </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">day_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">),</span>
<span class="w">                </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.85</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.3</span><span class="p">),</span><span class="w"> </span><span class="c1"># change the y-axis range here</span>
<span class="w">                     </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1"># change the y-axis breaks here</span>
<span class="w">  </span><span class="nf">scale_x_datetime</span><span class="p">(</span><span class="n">date_breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1 day&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1"># change the date break here for different x-axis label. A more specific format can be specified.</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1"># rotate date label 90 degree.</span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;predicted ground illuminance (lx)&quot;</span><span class="p">)</span><span class="w"> </span>

<span class="n">plot_output</span>

<span class="nf">beep</span><span class="p">()</span>

<span class="c1"># Save plot:</span>
<span class="nf">ggsave</span><span class="p">(</span><span class="s">&quot;plot_output.png&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_output</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4488</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2000</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;px&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">dpi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">450</span><span class="p">)</span>

<span class="c1">## .png can be changed to .pdf to save as a vector file.</span>
<span class="c1">## However when exporting as .pdf, the shading transparency (alpha setting) might not look right. This is a limitation of R.</span>

<span class="c1">#---------------------------Lunar eclipse warning---------------------------</span>

<span class="c1"># MoonShineR warns the user if an eclipse occurs during a simulation, and it reports the start and end time of the simulation.</span>
<span class="c1"># However, MoonShineR does not simulate the reduction in moon ground illuminance associated with the eclipse.</span>

<span class="nf">if </span><span class="p">(</span><span class="nf">any</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1.5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># eclipse defined as a moon with phase angle &lt; 1.5 during nighttime</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;ECLIPSE IN SIMULATION!!!&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">eclipse_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1.5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="n">eclipse_list</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),]</span>
<span class="p">}</span><span class="w"> </span><span class="n">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;no eclipse in simulation&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">#---------------------------END OF SCRIPT---------------------------</span>

<span class="c1"># References ---------------------------  </span>

<span class="c1"># Allen, C. W. (1976). Astrophysical quantities (3rd ed. 1973, Repr. with corrections 1976). Athelone Press.; [Distributor for] U.S.A. and Canada, Humanities Press.</span>
<span class="c1"># Austin, R. H., Phillips, B. F., &amp; Webb, D. J. (1976). A method for calculating moonlight illuminance at the earth’s surface. The Journal of Applied Ecology, 13(3), 741. https://doi.org/10.2307/2402251</span>
<span class="c1"># Buratti, B. J., Hillier, J. K., &amp; Wang, M. (1996). The lunar opposition surge: Observations by clementine. Icarus, 124(2), 490–499. https://doi.org/10.1006/icar.1996.0225</span>
<span class="c1"># Hänel, A., Posch, T., Ribas, S. J., Aubé, M., Duriscoe, D., Jechow, A., Kollath, Z., Lolkema, D. E., Moore, C., Schmidt, N., Spoelstra, H., Wuchterl, G., &amp; Kyba, C. C. M. (2018). Measuring night sky brightness: Methods and challenges. Journal of Quantitative Spectroscopy and Radiative Transfer, 205, 278–290. https://doi.org/10.1016/j.jqsrt.2017.09.008</span>
<span class="c1"># Krisciunas, K., &amp; Schaefer, B. E. (1991). A model of the brightness of moonlight. Publications of the Astronomical Society of the Pacific, 103, 1033. https://doi.org/10.1086/132921</span>
<span class="c1"># Laue, E. G. (1970). The measurement of solar spectral irradiance at different terrestrial elevations. Solar Energy, 13(1), 43–57. https://doi.org/10.1016/0038-092X(70)90006-X</span>
<span class="c1"># Schaefer, B. E. (1990). Telescopic limiting magnitudes. Publications of the Astronomical Society of the Pacific, 102, 212. https://doi.org/10.1086/132629</span>
<span class="c1"># Seidelmann, P. K., United States Naval Observatory, &amp; Great Britain (Eds.). (1992). Explanatory supplement to the Astronomical almanac (Rev. ed.). University Science Books.</span>

<span class="c1"># Notes ---------------------------  </span>

<span class="c1">## Be careful with radian and degree angle</span>
<span class="c1">### Calculations in Krisciunas &amp; Scaefer 1991 model uses degree angle</span>
<span class="c1">### suncalc functions gives radian. R trigonometry function takes radian.</span>

<span class="c1">## Zenith distance of the moon = 90 degree angle - moon altitude</span>

<span class="c1">## Phase output from suncalc::getMoonIllumination:</span>
<span class="c1">### 0 = new moon</span>
<span class="c1">### 0.25 = first quarter (waxing)</span>
<span class="c1">### 0.5 = full</span>
<span class="c1">### 0.75 = third/last quarter (waning)</span>

<span class="c1">## To convert phase to phase angle (following the sign convention of Krisciunas &amp; Schaefer 1991):</span>
<span class="c1">### phase_angle &lt;- phase*(-360)+180</span>
<span class="c1">#### positive = waxing </span>
<span class="c1">#### negative = waning </span>
<span class="c1">#### 180 = new moon</span>
<span class="c1">#### 90 = 1st quarter (waxing)</span>
<span class="c1">#### 0 = full</span>
<span class="c1">#### -90 = 2nd quarter (waning)</span>
</pre></div>
</div>
</section>
<section id="span-style-font-variant-small-caps-moonshiner-span-moonlight-scheduler">
<h2><span style="font-variant:small-caps;">MoonShineR</span>: Moonlight scheduler<a class="headerlink" href="#span-style-font-variant-small-caps-moonshiner-span-moonlight-scheduler" title="Permalink to this headline">#</a></h2>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># MoonShineR - Moonlight scheduler</span>
<span class="c1"># An R program by C. Lok Poon, Crampton Electric Fish Lab, University of Central Florida, Copyright 2023</span>
<span class="c1"># A detailed guide about this program: https://lokpoon.github.io/moonshine_manual/moonlight_LED_scheduler.html</span>

<span class="c1"># Description:</span>
<span class="c1"># This script generates a LED_schedule_moon.csv schedule file for MoonShineP to re-create a moonlight regime.</span>

<span class="c1"># Load libraries ---------------------------</span>

<span class="nf">library</span><span class="p">(</span><span class="n">suncalc</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">rpmodel</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">REdaS</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">npreg</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">beepr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>

<span class="c1">#---------------------------START OF PARAMETER SETTINGS---------------------------</span>

<span class="c1"># (!) indicates a user specified setting</span>

<span class="c1"># Set working directory:</span>
<span class="nf">setwd</span><span class="p">(</span><span class="s">&quot;/Users/lokpoon/Desktop&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1"># (!) Set working directory. .csv and .png files will be saved to this directory</span>


<span class="c1"># Set the location and time ---------------------------</span>
<span class="n">latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-4.21528</span><span class="w"> </span><span class="c1"># (!) Latitude in decimal degrees (e.g., -4.21528)</span>
<span class="n">longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-69.94056</span><span class="w"> </span><span class="c1"># (!) Longitude in decimal degrees (e.g., -69.94056)</span>
<span class="n">site_elev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="c1"># (!) site elevation in meter (e.g., 0 = sea level). Elevation correction only applies to moonlight but not sunlight and twilight.</span>
<span class="c1"># The user can determine the site elevation of a coordinate location using https://www.dcode.fr/earth-elevation</span>

<span class="n">time_zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;EST&quot;</span><span class="w"> </span><span class="c1"># (!) Set the time zone for the location set (e.g., “EST”). REMEMBER TO CHANGE THE TIME ZONE WHEN THE LOCATION IS CHANGED.</span>
<span class="c1">## Enter the following text in R console for a list of the time zone name: OlsonNames(tzdir = NULL)</span>
<span class="c1">## Use a time zone without DST. E.g., use &quot;EST&quot; instead of &quot;America/New_York&quot;</span>
<span class="n">date_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;2023-03-01&quot;</span><span class="w"> </span><span class="c1"># (!) Starting date of the simulation (YYYY-MM-DD)</span>
<span class="n">time_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;18:00:00&quot;</span><span class="w"> </span><span class="c1"># (!) Starting date of the simulation (hh:mm:ss)</span>
<span class="n">duration_day</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># (!) Duration of simulation in days</span>

<span class="c1"># Set nominal dark sky value ---------------------------</span>
<span class="c1">## Adding a baseline illumination to the model to represent other nocturnal light sources (e.g., starlight and airglow) (Hänel et al. 2017) </span>
<span class="n">darksky_value</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.0008</span><span class="w"> </span><span class="c1"># (!) Choose from between 0.0006 to 0.0009. Default = 0.0008</span>
<span class="c1">## change it to zero if a complete darkness (during moonless night) is preferred (i.e., no starlight or skyglow)</span>

<span class="c1"># LED strip configuration---------------------------</span>

<span class="n">theoretical_max</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.4</span><span class="w"> </span><span class="c1"># (!) Define an intensity upper limit (in lx) so that the LED system is not instructed to exceed 100% output intensity.</span>
<span class="c1">## Refer to online MoonShine Manual part 7.</span>
<span class="c1">## Increasing theoretical_max will reduce the illuminance to the LED.</span>

<span class="n">diode_per_strip</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">144</span><span class="w"> </span><span class="c1"># (!) Number of LEDs per strip</span>
<span class="n">strip_count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">2</span><span class="w"> </span><span class="c1"># (!) Number of daisy-chained LED strips</span>

<span class="c1"># LED spectral control---------------------------</span>
<span class="c1"># Input the intensity fraction (0-1) each LED color is outputting. Each is independent. </span>
<span class="n">white_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1.0</span><span class="w"> </span><span class="c1"># (!) White. Default = 1.0</span>
<span class="n">red_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.08</span><span class="w"> </span><span class="c1"># (!) Red. Default = 0.08</span>
<span class="n">green_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.36</span><span class="w"> </span><span class="c1"># (!) Green. Default = 0.36</span>
<span class="n">blue_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.19</span><span class="w"> </span><span class="c1"># (!) Blue. Default = 0.19</span>
<span class="c1"># These default RGBW fractions approximate the spectrum of moonlight when used with the intended SK6812 RGBW LED strip of the warm white specification.</span>
<span class="c1"># To change color balance from white to, for example, a red-shifted light, the user can increase the red_fraction, incrementally, until the color generated by lightbox reaches desired parameters on a spectrometer.</span>
<span class="c1"># Please recognize the narrow band nature of the RGB LED and utilize it accordingly.</span>

<span class="c1"># Horizon obstruction---------------------------</span>
<span class="c1"># Recreate potential obstructions of moonlight from the horizon (anywhere except sea level). E.g., tall mountain range or tree line around a forest gap.</span>
<span class="n">horizon_option</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">FALSE</span><span class="w"> </span><span class="c1"># (!) TRUE to enable</span>
<span class="n">horizon_transition_end</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">57</span><span class="w"> </span><span class="c1"># (!) angular altitude* ABOVE which there is a zone of unobstructed illumination. We define this as Zone A.</span>
<span class="n">horizon_elev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">55</span><span class="w"> </span><span class="c1"># (!) angular altitude* BELOW which there is maximum light attenuation (e.g. due to a mountain or tree line). We DEFINE THIS AS ZONE C.</span>
<span class="c1"># * The angular altitude refers to the angle above the horizon, from 0 degrees at the horizon to 90 degrees at the zenith.</span>
<span class="n">horiz_transmission</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.15</span><span class="w"> </span><span class="c1"># (!) the proportional transmission of light in Zone A relative to Zone C. For example, if a value of 0.15 is chosen, and horizon_elev is set to 55, light level in the zone below 55 degrees will be 15% of the light level above the angle of “horizon_transition_end”.</span>
<span class="c1"># Zones A and C delimit a third, intervening zone B (e.g. between 55 and 60 degrees above the horizon). A linear transition of light level is applied between horizon_elev and horizon_transition_end. This makes light level transitions less abrupt when the simulated moon rises above simulated obstacles. </span>

<span class="c1"># Cloud cover settings ---------------------------</span>
<span class="n">cloud_option</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">FALSE</span><span class="w"> </span><span class="c1"># (!) TRUE to enable cloud simulator</span>
<span class="c1"># User should review graphical output of simulation in the next section, and adjust parameters accordingly, before deployment of the simulation with MoonShineP.</span>
<span class="n">date_start_cloud</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">date_start</span><span class="w"> </span><span class="c1"># (!) starting date of cloud effect (YYYY-MM-DD)</span>
<span class="n">time_start_cloud</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">time_start</span><span class="w"> </span><span class="c1"># (!) starting time of cloud effect (hh:mm:ss)</span>
<span class="n">duration_day_cloud</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">duration_day</span><span class="w"> </span><span class="c1"># (!) duration of the cloud effect</span>
<span class="n">cloud_change_freq</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">30</span><span class="w"> </span><span class="c1"># (!) Sets how quickly the clouds are transitioning (in minutes). Set this value to &gt; or = 5. A value of &lt;5 may crash R session.</span>
<span class="c1"># A value of 5 simulates rapid movement of clouds across the moon’s disk, due to high-speed winds at cloud altitude. A value of 30 represents very slow cloud movement.</span>
<span class="n">transmission_mean</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># (!) Set the mean of the normal distribution. A value of 1 means cloud simulator is using only the ‘left’ half of the normal distribution. This simulates an occasional cloud passing across the moon.</span>
<span class="c1"># A value over 1 will reduce the frequency and extremity of cloud cover (we recommend not exceeding 2).</span>
<span class="c1"># Zero or a negative value will use the right side of the normal distribution – simulating denser cloud cover with occasional periods of no cloud cover (we recommend values no lower than -1). Avoid using a value between 0 and 1.</span>

<span class="n">transmission_sd</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.5</span><span class="w"> </span><span class="c1"># (!) Set the SD of the of the normal distribution. We recommend starting at 0.5, and increasing or decreasing this value slightly (e.g. change to 1.5) to thicken or thin the cloud passing by.</span>
<span class="c1"># The user can create ‘tailored’ weather changes by running MoonShineR moonlight scheduler for a defined start and end period, using one set of cloud simulator parameters, and then running the entire simulation for a subsequent period of time, this time using a new set of cloud simulator parameters. The user can then manually concatenate the data in the .csv files.</span>
<span class="c1"># This procedure can be repeated for as many major transitions in weather are required during a simulation. </span>

<span class="c1"># The cloud simulator works by applying a cloud_table dataframe that contains the proportional moonlight transmission value for each minute (recalling that lightbox operations are constrained to changes in light every minute as defined by time_interval_minutes).</span>
<span class="c1"># The cloud_table dataframe is generated in two stages. First, it create a set of random data points (each representing simulated light transmission values for a given time), with the value of these data points constrained within a normal distribution.</span>
<span class="c1"># The user is able to control the following parameters of this normal distribution: 1) the mean; 2) the standard deviation; 3) the number of values per unit time, with 1 value per minute being the minimum. The cloud simulator then applies a smoothing spline to this distribution to create a smooth transition in light transmission.</span>
<span class="c1"># Finally values from this spline are interpolated at one minute intervals to provide the required values for light generation by the LED array.</span>

<span class="c1">#--------------------------- START OF CLOUD EFFECT GENERATOR ---------------------------</span>

<span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># The temporal resolution of the simulation in minutes. Locked at 1 for MoonShineP to operate correctly.</span>
<span class="n">bit8</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">255</span><span class="w"> </span><span class="c1"># Controllable light intensity level of the LEDs is 255 (8 bit).</span>

<span class="c1"># Prepare a table for cloud stochastic values and plot</span>
<span class="c1"># Beware that the cloud effect is generated randomly every time.</span>
<span class="c1"># Unless set seed is enabled and the rest of the settings stay the same, in which the same cloud effect can be replicated by running the same code.</span>

<span class="nf">if </span><span class="p">(</span><span class="n">cloud_option</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">date_time_start_cloud</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="n">date_start_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">time_start_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>
<span class="w">  </span><span class="n">number_of_interval_cloud</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">days</span><span class="p">(</span><span class="n">duration_day_cloud</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">))</span>
<span class="w">  </span><span class="n">cloud_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number_of_interval_cloud</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cloud_change_freq</span><span class="p">))</span>
<span class="w">  </span><span class="nf">colnames</span><span class="p">(</span><span class="n">cloud_table</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># set.seed(1) # (!) un-comment the following line to enable set seed, so that cloud effect can be replicated when rerunning the same code</span>
<span class="w">  </span><span class="n">cloud_table</span><span class="o">$</span><span class="n">cloud_transmission</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rnorm</span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number_of_interval_cloud</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cloud_change_freq</span><span class="p">,</span><span class="w"> </span><span class="n">mean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmission_mean</span><span class="p">,</span><span class="w"> </span><span class="n">sd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">transmission_sd</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="n">time_interval_cloud_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_interval_cloud</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">cloud_change_freq</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">time_interval_cloud_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cloud_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;datetime&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start_cloud</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cloud_change_freq</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">))[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;date&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">cloud_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">cloud_table</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="w">  </span>
<span class="w">  </span><span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="m">1</span><span class="p">))</span>
<span class="w">  </span>
<span class="w">  </span><span class="c1"># Plot the spline fit to visualize cloud transmission that will be applied:</span>
<span class="w">  </span><span class="n">mod.ss0</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ss</span><span class="p">(</span><span class="n">cloud_table</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_table</span><span class="o">$</span><span class="n">cloud_transmission</span><span class="p">,</span><span class="w"> </span><span class="n">all.knots</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">,</span><span class="w"> </span><span class="n">lambda</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">number_of_interval_cloud</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1e-12</span><span class="p">)</span><span class="w"> </span>
<span class="w">  </span><span class="c1"># The lambda multiplied constant can be reduced to create less abrupt transitions.</span>
<span class="w">  </span><span class="c1"># However, in most cases, the default 1e-12 can be left unchanged as it closely resembles the abrupt change of light caused by passing cloud.</span>
<span class="w">  </span><span class="c1"># An increase in the lambda value (e.g., to 1e-8) will make the transition slightly smoother but at the expense of narrowing the range of used values. </span>
<span class="w">  </span>
<span class="w">  </span><span class="nf">plot</span><span class="p">(</span><span class="n">mod.ss0</span><span class="p">,</span><span class="w"> </span><span class="n">ylim</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">xlab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;duration of cloud effect&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ylab</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;fraction of light that passes through cloud&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="nf">points</span><span class="p">(</span><span class="n">cloud_table</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_table</span><span class="o">$</span><span class="n">cloud_transmission</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># Calculate the cloud effect on each minute</span>
<span class="nf">if </span><span class="p">(</span><span class="n">cloud_option</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">smoothing_cloud</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">mod.ss0</span><span class="w"> </span><span class="c1"># (!) select smoothing model from above</span>
<span class="w">  </span>
<span class="w">  </span><span class="n">time_interval_cloud_list_full</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_interval_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="w">  </span><span class="n">cloud_table_full</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number_of_interval_cloud</span><span class="p">))</span>
<span class="w">  </span><span class="nf">colnames</span><span class="p">(</span><span class="n">cloud_table_full</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">  </span><span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">time_interval_cloud_list_full</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cloud_table_full</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;datetime&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start_cloud</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;date&quot;</span><span class="p">]</span>
<span class="w">    </span><span class="n">cloud_table_full</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloud_transmission&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">smoothing_cloud</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_table_full</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;datetime&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">deriv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">cloud_table_full</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloud_transmission&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">cloud_table_full</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloud_transmission&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="p">}</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">cloud_table_full</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloud_transmission&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">cloud_table_full</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;cloud_transmission&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">cloud_table_full</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">cloud_table_full</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
<span class="p">}</span>

<span class="c1">#--------------------------- END OF CLOUD EFFECT GENERATOR---------------------------</span>
<span class="c1">#--------------------------- END OF PARAMETER SETTINGS---------------------------</span>

<span class="c1">#---------------------------START OF ILLUMINATION COMPUTATION-------------------</span>

<span class="c1"># Start time formatting</span>
<span class="n">date_time_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">time_start</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>
<span class="n">number_of_interval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">ddays</span><span class="p">(</span><span class="n">duration_day</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">))</span>

<span class="c1"># Create an empty dataframe for filling with for loop</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number_of_interval</span><span class="p">))</span>
<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>

<span class="c1"># Create for loop [i] time interval list</span>
<span class="n">time_interval_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_interval</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span>

<span class="c1"># Create a progress bar object</span>
<span class="n">pb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">progress_bar</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">time_interval_list</span><span class="p">))</span>

<span class="c1"># Fill in empty data frame with suncalc data</span>
<span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">time_interval_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;datetime&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;date&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;phase_angle&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;phase&quot;</span><span class="p">])</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">-360</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">180</span><span class="w"> </span><span class="c1">#phase_angle = angular separation of the sun and Earth, as seen on the moon</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fraction&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="o">*</span><span class="m">60</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;fraction&quot;</span><span class="p">])</span><span class="w"> </span><span class="c1"># moon illuminated fraction, not used in calculation. This is calculated only for user to learn about the moon phase.</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Z_moon&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="nf">rad2deg</span><span class="p">(</span><span class="nf">getMoonPosition</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longitude</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;altitude&quot;</span><span class="p">]))</span><span class="w"> </span><span class="c1">#Z_moon = Zenith distance in degree of the moon = 90 - moon altitude</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;distance&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getMoonPosition</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longitude</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;distance&quot;</span><span class="p">]</span><span class="w"> </span><span class="c1">#distance = moon/Earth distance in km</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sun_altitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rad2deg</span><span class="p">(</span><span class="nf">getSunlightPosition</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;altitude&quot;</span><span class="p">))[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;altitude&quot;</span><span class="p">])</span><span class="w"> </span><span class="c1">#sun_altitude = altitude in degree of the sun</span>
<span class="w">  </span><span class="n">pb</span><span class="o">$</span><span class="nf">tick</span><span class="p">()</span><span class="w"> </span><span class="c1"># Update the progress bar</span>
<span class="p">}</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># Replace moon altitude that are lower than horizon_elev with NA (moon below horizon)</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">Z_moon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">Z_moon</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="kc">NA</span><span class="p">,</span><span class="w"> </span><span class="n">Z_moon</span><span class="p">))</span><span class="w"> </span>

<span class="c1"># Calculate atmospheric extinction</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="m">-0.140194</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">Z_moon</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="m">-91.674385</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">Z_moon</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">0.03</span><span class="w"> </span><span class="c1"># A Michaelis-Menten that fits Table 2 in Austin et al. (1976)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="p">)</span>

<span class="c1"># Moon magnitude calculated from phase angle (unit in relative magnitude) (Allen 1976, p. 144)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">m</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="m">-12.73</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">0.026</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">-9</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">4</span><span class="p">)</span>

<span class="c1"># Temporary illuminance of moonlight (in unit foot candle) (see eq. (16) of Schaefer 1990a)</span>
<span class="n">illuminance_temp</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">((</span><span class="m">-0.4</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">m</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">atm_ext</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">16.57</span><span class="p">))</span><span class="w"> </span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">illuminance_temp</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">10.7639</span><span class="w"> </span><span class="c1">#convert to lux</span>

<span class="c1"># Correct for the effect of site altitude (i.e., elevation)</span>
<span class="n">atm_pressure_relative_to_sea</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">patm</span><span class="p">(</span><span class="n">site_elev</span><span class="p">,</span><span class="w"> </span><span class="n">patm0</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">101325</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">101325</span><span class="w"> </span><span class="c1"># the atmospheric pressure at the site elevation relative to sea level</span>
<span class="n">sea_555nm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">18.964</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">-0.229</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="c1"># Sea level irradiance at 555nm. Function extracted from figure 1 of Laue (1970)</span>
<span class="n">elevated_555nm</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">18.964</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">exp</span><span class="p">(</span><span class="m">-0.229</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">atm_pressure_relative_to_sea</span><span class="p">)</span><span class="w"> </span><span class="c1"># Sea level irradiance at 555nm. Function extracted from figure 1 of Laue (1970)</span>
<span class="n">increase_factor_elev</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">elevated_555nm</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">sea_555nm</span><span class="w"> </span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">increase_factor_elev</span>

<span class="c1"># Apply lunar opposition surge when p &lt; 6 (Buratti et al. 1996, figure 5)</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="m">0.4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">6</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">abs</span><span class="p">(</span><span class="n">phase_angle</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">6</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="p">),</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="p">))</span><span class="w"> </span>
<span class="c1">## A linear increase in moon brightness as phase angle decreases below 6</span>

<span class="c1"># Apply spreading out effect (angle of incidence) of light when illuminating at an angle (Austin et al. 1976)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">illuminance_temp_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="nf">sin</span><span class="p">(</span><span class="nf">deg2rad</span><span class="p">(</span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">Z_moon</span><span class="p">))</span>

<span class="c1"># The moon/Earth distance effect (inverse square law) (Austin et al. 1976)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">((</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">distance</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">384400</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">))</span>

<span class="c1"># Waxing Waning asymmetric effect (simplified function derived from Austin et al. 1976 Table 1)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">-0.00026</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1</span><span class="p">),</span>
<span class="w">                                          </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="p">)</span>

<span class="c1"># Final moonlight illuminance (with a slight adjustment factor, calibrated from Leticia, Colombia, Aug 11, 2022 field full moon measurement)</span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">0.863</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">replace</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="p">,</span><span class="w"> </span><span class="nf">is.na</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>


<span class="c1">#---------------------------APPLY CLOUD AND HORIZON ELEVATION EFFECT---------------------------</span>

<span class="c1"># Horizon elevation effect</span>
<span class="nf">if </span><span class="p">(</span><span class="n">horizon_option</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">((</span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Z_moon</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">horizon_elev</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="p">(</span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Z_moon</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">horizon_transition_end</span><span class="p">,</span><span class="w"> </span>
<span class="w">                                                                          </span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="m">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">horiz_transmission</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Z_moon</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">horizon_transition_end</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">horizon_transition_end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">horizon_elev</span><span class="p">))),</span><span class="w"> </span><span class="n">moon_final_lux</span><span class="p">))</span><span class="w"> </span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">((</span><span class="m">90</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">Z_moon</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">horizon_elev</span><span class="p">,</span><span class="w"> </span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">horiz_transmission</span><span class="p">,</span><span class="w"> </span><span class="n">moon_final_lux</span><span class="p">))</span><span class="w"> </span>
<span class="p">}</span>

<span class="c1"># Add baseline dark sky illuminance (starlight not really affected by the horizon obstruction, but is subjected to the cloud effect)</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="p">[</span><span class="nf">is.na</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="p">)]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">darksky_value</span><span class="w"> </span>

<span class="c1"># Cloud effect</span>
<span class="nf">if </span><span class="p">(</span><span class="n">cloud_option</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">left_join</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_table_full</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;datetime&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="w"> </span><span class="o">%&gt;%</span>
<span class="w">    </span><span class="nf">mutate</span><span class="p">(</span><span class="n">cloud_transmission</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">if_else</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">cloud_transmission</span><span class="p">),</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">cloud_transmission</span><span class="p">))</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">cloud_transmission</span>
<span class="p">}</span>

<span class="c1">#---------------------------END OF ILLUMINATION COMPUTATION--------------------</span>

<span class="c1">#---------------------------GENERATE LED_schedule_moon.csv---------------------------</span>

<span class="c1">#scale the model illumination to an intensity fraction by dividing it by the theoretical_max</span>
<span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">moon_final_lux</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">theoretical_max</span>

<span class="c1">#Calculate the RGBW crude and fine values for moonlight recreation</span>
<span class="n">temp_white_intensity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bit8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">white_fraction</span>
<span class="n">crudewhite</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">temp_white_intensity</span><span class="p">)</span>
<span class="n">wfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">((</span><span class="n">temp_white_intensity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">crudewhite</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diode_per_strip</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">strip_count</span><span class="p">)</span>

<span class="n">temp_red_intensity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bit8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">red_fraction</span>
<span class="n">crudered</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">temp_red_intensity</span><span class="p">)</span>
<span class="n">rfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">((</span><span class="n">temp_red_intensity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">crudered</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diode_per_strip</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">strip_count</span><span class="p">)</span>

<span class="n">temp_green_intensity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bit8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">green_fraction</span>
<span class="n">crudegreen</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">temp_green_intensity</span><span class="p">)</span>
<span class="n">gfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">((</span><span class="n">temp_green_intensity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">crudegreen</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diode_per_strip</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">strip_count</span><span class="p">)</span>

<span class="n">temp_blue_intensity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bit8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blue_fraction</span>
<span class="n">crudeblue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">temp_blue_intensity</span><span class="p">)</span>
<span class="n">bfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">((</span><span class="n">temp_blue_intensity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">crudeblue</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diode_per_strip</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">strip_count</span><span class="p">)</span>

<span class="c1">#Fill moon_value_table with LED color crude and fine values. NA converted to 0.</span>
<span class="n">moon_value_table</span><span class="o">$</span><span class="n">crudewhite</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crudewhite</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">crudewhite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">crudewhite</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">crudewhite</span><span class="p">))</span><span class="w"> </span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">wfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">wfine</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">wfine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">wfine</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">wfine</span><span class="p">))</span><span class="w"> </span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">crudered</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crudered</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">crudered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">crudered</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">crudered</span><span class="p">))</span><span class="w"> </span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">rfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">rfine</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">rfine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">rfine</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">rfine</span><span class="p">))</span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">crudegreen</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crudegreen</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">crudegreen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">crudegreen</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">crudegreen</span><span class="p">))</span><span class="w"> </span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">gfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">gfine</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">gfine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">gfine</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">gfine</span><span class="p">))</span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">crudeblue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">crudeblue</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">crudeblue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">crudeblue</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">crudeblue</span><span class="p">))</span><span class="w"> </span>

<span class="n">moon_value_table</span><span class="o">$</span><span class="n">bfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">bfine</span>
<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">bfine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">bfine</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">bfine</span><span class="p">))</span><span class="w"> </span>

<span class="n">moon_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">atm_ext</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">,</span><span class="w"> </span><span class="n">illuminance_temp_lux</span><span class="p">))</span><span class="w"> </span><span class="c1"># remove extra columns</span>


<span class="c1"># Save moon table csv file</span>
<span class="nf">write.csv</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="s">&quot;LED_schedule_moon.csv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Explanation for the columns found in LED_schedule_moon.csv:</span>
<span class="c1"># Use whichever illuminance prediction is appropriate for desired use. </span>

<span class="c1">## datetime = The datetime in a standard format that R and moonshine_moon.py can read</span>
<span class="c1">## phase_angle = the phase angle of the moon</span>
<span class="c1">## fraction = the illuminated fraction of the moon</span>
<span class="c1">## Z_moon = zenith distance of the moon in degree angle</span>
<span class="c1">## distance = the moon and Earth distance in km</span>
<span class="c1">## sun_altitude = The altitude of the sun. Positive/negative value means the sun is above/below the horizon, respectively.</span>
<span class="c1">## moon_final_lux = illuminance of moonlight (plus the darksky_value)</span>
<span class="c1">## crude and fine LED values for each RGBW = the LED values that moonshine_moon.py will use instruct the LED at the given time.</span>

<span class="c1">#---------------------------Plotting Section---------------------------</span>

<span class="c1"># Ploting the moonlight illuminance that will be re-created.</span>
<span class="c1"># Dark gray area depicts dark periods (true night after astronomical twilight ended).</span>
<span class="c1"># Light gray area indicate the periods of astronomical twilight.</span>

<span class="n">plot_option</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="c1"># (!) FALSE to turn off plotting</span>

<span class="c1"># Create a clean ggplot theme</span>
<span class="n">theme_rectangular_clean</span><span class="w"> </span><span class="o">&lt;-</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unit</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s">&quot;cm&quot;</span><span class="p">))</span>

<span class="c1"># Specify the time of night period and twilight period for shading</span>
<span class="n">night_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">night_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">night_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>

<span class="n">after_twilight_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="m">-18</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">after_twilight_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">after_twilight_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">time_zone</span><span class="p">)</span>

<span class="n">day_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">day_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">day_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>

<span class="c1"># Plotting:</span>
<span class="n">plot_output</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_rectangular_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">night_time</span><span class="p">,</span><span class="w"> </span><span class="c1"># night period</span>
<span class="w">                </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">night_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">),</span>
<span class="w">                </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey88&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">after_twilight_time</span><span class="p">,</span><span class="w"> </span><span class="c1"># after twilight</span>
<span class="w">                </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">after_twilight_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">),</span>
<span class="w">                </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey80&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moon_value_table</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">moon_final_lux</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.75</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">day_time</span><span class="p">,</span><span class="w"> </span><span class="c1"># day time mask moonlight regression to gray color</span>
<span class="w">                </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">day_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">),</span>
<span class="w">                </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.85</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">0.3</span><span class="p">),</span><span class="w"> </span><span class="c1"># change the y-axis range here</span>
<span class="w">                     </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.1</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1"># change the y-axis breaks here</span>
<span class="w">  </span><span class="nf">scale_x_datetime</span><span class="p">(</span><span class="n">date_breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1 day&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1"># change the date break here for different x-axis label. More specific format can be specified.</span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;predicted ground illuminance (lx)&quot;</span><span class="p">)</span><span class="w"> </span>


<span class="n">plot_output</span>

<span class="nf">beep</span><span class="p">()</span>

<span class="c1"># Save plot:</span>
<span class="nf">ggsave</span><span class="p">(</span><span class="s">&quot;moon_plot_output.png&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_output</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4488</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2000</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;px&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">dpi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">450</span><span class="p">)</span>
<span class="c1">## .png can be changed to .pdf to save as a vector file.</span>
<span class="c1">## However when exporting as .pdf, the shading transparency (alpha setting) might not look right. This is a limitation of R.</span>

<span class="c1">#---------------------------Lunar eclipse warning---------------------------</span>

<span class="c1"># MoonShineR warns the user if an eclipse occurs during a simulation, and it reports the start and end time of the simulation.</span>
<span class="c1"># However, MoonShineR does not simulate the reduction in moon ground illuminance associated with the eclipse.</span>

<span class="nf">if </span><span class="p">(</span><span class="nf">any</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1.5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">))</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="c1"># eclipse defined as a moon with phase angle &lt; 1.5 during nighttime</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;ECLIPSE IN SIMULATION!!!&quot;</span><span class="p">)</span>
<span class="w">  </span><span class="n">eclipse_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">phase_angle</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">1.5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">moon_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span>
<span class="w">  </span><span class="n">moon_value_table</span><span class="p">[</span><span class="nf">which</span><span class="p">(</span><span class="n">eclipse_list</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">),]</span>
<span class="p">}</span><span class="w"> </span><span class="n">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">print</span><span class="p">(</span><span class="s">&quot;no eclipse in simulation&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">#---------------------------END OF SCRIPT---------------------------</span>

<span class="c1"># References ---------------------------  </span>

<span class="c1"># Allen, C. W. (1976). Astrophysical quantities (3rd ed. 1973, Repr. with corrections 1976). Athelone Press.; [Distributor for] U.S.A. and Canada, Humanities Press.</span>
<span class="c1"># Austin, R. H., Phillips, B. F., &amp; Webb, D. J. (1976). A method for calculating moonlight illuminance at the earth’s surface. The Journal of Applied Ecology, 13(3), 741. https://doi.org/10.2307/2402251</span>
<span class="c1"># Buratti, B. J., Hillier, J. K., &amp; Wang, M. (1996). The lunar opposition surge: Observations by clementine. Icarus, 124(2), 490–499. https://doi.org/10.1006/icar.1996.0225</span>
<span class="c1"># Hänel, A., Posch, T., Ribas, S. J., Aubé, M., Duriscoe, D., Jechow, A., Kollath, Z., Lolkema, D. E., Moore, C., Schmidt, N., Spoelstra, H., Wuchterl, G., &amp; Kyba, C. C. M. (2018). Measuring night sky brightness: Methods and challenges. Journal of Quantitative Spectroscopy and Radiative Transfer, 205, 278–290. https://doi.org/10.1016/j.jqsrt.2017.09.008</span>
<span class="c1"># Krisciunas, K., &amp; Schaefer, B. E. (1991). A model of the brightness of moonlight. Publications of the Astronomical Society of the Pacific, 103, 1033. https://doi.org/10.1086/132921</span>
<span class="c1"># Laue, E. G. (1970). The measurement of solar spectral irradiance at different terrestrial elevations. Solar Energy, 13(1), 43–57. https://doi.org/10.1016/0038-092X(70)90006-X</span>
<span class="c1"># Schaefer, B. E. (1990). Telescopic limiting magnitudes. Publications of the Astronomical Society of the Pacific, 102, 212. https://doi.org/10.1086/132629</span>
<span class="c1"># Seidelmann, P. K., United States Naval Observatory, &amp; Great Britain (Eds.). (1992). Explanatory supplement to the Astronomical almanac (Rev. ed.). University Science Books.</span>

<span class="c1"># Notes ---------------------------  </span>

<span class="c1">## Be careful with radian and degree angle</span>
<span class="c1">### Calculations in Krisciunas &amp; Scaefer 1991 model uses degree angle</span>
<span class="c1">### suncalc functions gives radian. R trigonometry function takes radian.</span>

<span class="c1">## Zenith distance of the moon = 90 degree angle - moon altitude</span>

<span class="c1">## Phase output from suncalc::getMoonIllumination:</span>
<span class="c1">### 0 = new moon</span>
<span class="c1">### 0.25 = first quarter (waxing)</span>
<span class="c1">### 0.5 = full</span>
<span class="c1">### 0.75 = third/last quarter (waning)</span>

<span class="c1">## To convert phase to phase angle (following the sign convention of Krisciunas &amp; Schaefer 1991):</span>
<span class="c1">### phase_angle &lt;- phase*(-360)+180</span>
<span class="c1">#### positive = waxing </span>
<span class="c1">#### negative = waning </span>
<span class="c1">#### 180 = new moon</span>
<span class="c1">#### 90 = 1st quarter (waxing)</span>
<span class="c1">#### 0 = full</span>
<span class="c1">#### -90 = 2nd quarter (waning)</span>
</pre></div>
</div>
</section>
<section id="span-style-font-variant-small-caps-moonshiner-span-sunlight-twilight-scheduler">
<h2><span style="font-variant:small-caps;">MoonShineR</span>: Sunlight/twilight scheduler<a class="headerlink" href="#span-style-font-variant-small-caps-moonshiner-span-sunlight-twilight-scheduler" title="Permalink to this headline">#</a></h2>
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="c1"># MoonShineR - Sunlight/twilight LED scheduler</span>
<span class="c1"># An R program by C. Lok Poon, Crampton Electric Fish Lab, University of Central Florida, Copyright 2023</span>
<span class="c1"># A detailed guide about this program: https://lokpoon.github.io/moonshine_manual/sunlight_twilight_LED_scheduler.html</span>

<span class="c1"># Description:</span>
<span class="c1"># This script generates a LED_schedule_sun.csv schedule file for MoonShineP to re-create a sunlight/twilight regime.</span>

<span class="c1"># Load libraries --------------,-------------</span>

<span class="nf">library</span><span class="p">(</span><span class="n">dplyr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">suncalc</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">lubridate</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">REdaS</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">beepr</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">stats</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">npreg</span><span class="p">)</span>
<span class="nf">library</span><span class="p">(</span><span class="n">progress</span><span class="p">)</span>

<span class="c1">#---------------------------START OF PARAMETER SETTINGS---------------------------</span>

<span class="c1"># (!) indicates a user specified setting</span>

<span class="c1"># Set working directory</span>
<span class="nf">setwd</span><span class="p">(</span><span class="s">&quot;/Users/lokpoon/Desktop&quot;</span><span class="p">)</span><span class="w"> </span><span class="c1"># (!) Set working directory. Place R program here. .csv and .jpg files will be saved to this directory</span>

<span class="c1"># Set the location and time ---------------------------</span>
<span class="n">latitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-4.21528</span><span class="w"> </span><span class="c1"># (!) Latitude in decimal degrees (e.g., -4.21528)</span>
<span class="n">longitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">-69.94056</span><span class="w"> </span><span class="c1"># (!) Longitude in decimal degrees (e.g., -69.94056)</span>

<span class="n">time_zone</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;EST&quot;</span><span class="w"> </span><span class="c1"># (!) Set the time zone for the location set (e.g., “EST”). REMEMBER TO CHANGE THE TIME ZONE WHEN THE LOCATION IS CHANGED.</span>
<span class="c1"># Enter the following text in R console for a list of the time zone name: OlsonNames(tzdir = NULL)</span>
<span class="c1"># Highly recommend using a time zone without DST. E.g., use &quot;EST&quot; instead of &quot;America/New_York&quot;</span>
<span class="n">date_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;2023-03-01&quot;</span><span class="w"> </span><span class="c1"># (!) Starting date of the simulation (YYYY-MM-DD)</span>
<span class="n">time_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="s">&quot;18:00:00&quot;</span><span class="w"> </span><span class="c1"># (!) Starting date of the simulation (hh:mm:ss)</span>
<span class="n">duration_day</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># (!) Duration of simulation in days</span>

<span class="c1"># LED strip configuration ---------------------------</span>

<span class="n">theoretical_max</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">600</span><span class="w"> </span><span class="c1"># (!) Define an intensity upper limit (in lx) so that the LED system is not instructed to exceed 100% output intensity.</span>
<span class="c1">## Refer to online MoonShineP Manual part 7.</span>
<span class="c1">## Increasing theoretical_max will reduce the illuminance to the LED.</span>

<span class="n">diode_per_strip</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">144</span><span class="w"> </span><span class="c1"># (!) Number of LEDs per strip</span>
<span class="n">strip_count</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">4</span><span class="w"> </span><span class="c1"># (!) Number of daisy-chained LED strips</span>

<span class="c1"># Apply color shift  ---------------------------</span>
<span class="c1"># Pick either to use realistic_sunlight or a manual spectral shift.</span>
<span class="c1"># If realistic_sunlight is TRUE, an automatic spectral shift is applied, and the manual spectral shift is ignored.</span>
<span class="c1"># If realistic_sunlight is FALSE, the manual spectral shift is applied.</span>

<span class="c1"># LED spectral control---------------------------</span>
<span class="c1"># A) Default realistic twilight and sunlight spectral change. </span>
<span class="n">realistic_sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="c1"># (!) TRUE to enable</span>
<span class="c1"># This automatically sets the color spectrum to a realistic color of sunlight and twilight. It simulate the color change during sunrise/set and twilight periods (Palmer &amp; Johnsen 2015) according to the sun&#39;s altitude.</span>
<span class="c1"># If realistic_sunlight is enabled, it will override and ignore the manual spectral shift settings in the next section.</span>

<span class="c1"># B) Manual spectral shift (a constant shift, does not change with sun&#39;s altitude)</span>
<span class="c1"># This can be used to approximate a specific light spectrum of habitat or anthropogenic light.</span>
<span class="c1"># Input the intensity fraction (0-1) each LED color is outputting. Each is independent. </span>
<span class="n">white_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1.0</span><span class="w"> </span><span class="c1"># (!) White. Default = 1.0</span>
<span class="n">red_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.08</span><span class="w"> </span><span class="c1"># (!) Red. Default = 0.08</span>
<span class="n">green_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.36</span><span class="w"> </span><span class="c1"># (!) Green. Default = 0.36</span>
<span class="n">blue_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0.19</span><span class="w"> </span><span class="c1"># (!) Blue. Default = 0.19</span>
<span class="c1"># The default values approximate the sunlight spectrum.</span>
<span class="c1"># To change color balance from white to, for example, a blue-shifted light, the user can decrease other color fractions except for blue_fraction, incrementally, until the color generated by lightbox reaches desired parameters on a spectrometer.</span>
<span class="c1"># Please recognize the narrow band nature of the RGB LED and utilize it accordingly.</span>

<span class="c1">#---------------------------END OF PARAMETER SETTINGS---------------------------</span>

<span class="c1">#---------------------------START OF ILLUMINATION COMPUTATION---------------------------</span>

<span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="c1"># The temporal resolution of the simulation in minutes. Locked at 1 for MoonShineP to operate correctly.</span>
<span class="n">bit8</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">255</span><span class="w"> </span><span class="c1"># Controllable light intensity level of the LEDs is 255 (8 bit).</span>

<span class="c1"># Start time formatting</span>
<span class="n">date_time_start</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="n">date_start</span><span class="p">,</span><span class="w"> </span><span class="n">time_start</span><span class="p">,</span><span class="w"> </span><span class="n">sep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">collapse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">NULL</span><span class="p">),</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>
<span class="n">number_of_interval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">ddays</span><span class="p">(</span><span class="n">duration_day</span><span class="p">))</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="nf">as.numeric</span><span class="p">(</span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">))</span>

<span class="c1"># Create an empty dataframe for filling with for loop</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">number_of_interval</span><span class="p">))</span>
<span class="n">x</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">x</span>

<span class="c1"># Create for loop [i] time interval list</span>
<span class="n">time_interval_list</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">number_of_interval</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span>

<span class="c1"># Create a progress bar object</span>
<span class="n">pb</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">progress_bar</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">time_interval_list</span><span class="p">))</span>

<span class="c1"># Fill in empty data frame with suncalc data</span>
<span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">time_interval_list</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">sun_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;datetime&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">getMoonIllumination</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;date&quot;</span><span class="p">]</span>
<span class="w">  </span><span class="n">sun_value_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sun_altitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">rad2deg</span><span class="p">(</span><span class="nf">getSunlightPosition</span><span class="p">(</span><span class="n">date</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">date_time_start</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">time_interval_minutes</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m">60</span><span class="p">,</span><span class="w"> </span><span class="n">lat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">latitude</span><span class="p">,</span><span class="w"> </span><span class="n">lon</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">longitude</span><span class="p">,</span><span class="w"> </span><span class="n">keep</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;altitude&quot;</span><span class="p">))[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;altitude&quot;</span><span class="p">])</span><span class="w"> </span><span class="c1">#sun_altitude = altitude of the sun in degree</span>
<span class="w">  </span><span class="n">pb</span><span class="o">$</span><span class="nf">tick</span><span class="p">()</span><span class="w"> </span><span class="c1"># Update the progress bar</span>
<span class="p">}</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="c1"># Calculate twilight illuminance</span>
<span class="c1"># Following the polynomial function in Seidelmann (1992) p. 491</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-0.8</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">2.88</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">22.26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">207.64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1034.3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="p">)</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-0.8</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-5</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">2.88</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">21.81</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">258.11</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">858.36</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="p">)</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-12</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">2.7</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">12.17</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">431.69</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">1899.83</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="p">)</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">-12</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">-18</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">13.84</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">262.72</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1447.42</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">2797.93</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="p">)</span>

<span class="c1"># Calculate sunlight (SUN &gt; 0 degree) illuminance---------------------------</span>
<span class="c1"># Following the polynomial function in Seidelmann (1992) p. 491</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">20</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">3.74</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">3.97</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">4.07</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1.47</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="p">)</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">20</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">5</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">3.05</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">13.28</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">45.98</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">64.33</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="p">)</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">5</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">,</span>
<span class="w">                                    </span><span class="m">10</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="p">(</span><span class="m">2.88</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="m">22.26</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m">207.64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="m">1034.3</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">((</span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="m">90</span><span class="p">)</span><span class="w"> </span><span class="o">^</span><span class="w"> </span><span class="m">3</span><span class="p">)),</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="p">)</span>

<span class="c1"># Add sunlight and twilight together</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">raw_twilight_sun</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">twilight</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sunlight</span><span class="w"> </span><span class="c1"># add twilight and sunlight illuminance together</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">raw_twilight_sun</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">illuminance_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">raw_twilight_sun</span><span class="w"> </span><span class="c1"># apply illuminance_fraction</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">adjusted_twilight_sun</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="n">raw_twilight_sun</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">theoretical_max</span><span class="p">,</span><span class="w"> </span><span class="n">theoretical_max</span><span class="p">,</span><span class="w"> </span><span class="n">raw_twilight_sun</span><span class="p">))</span><span class="w"> </span><span class="c1"># apply the ceiling for sunlight recreation</span>

<span class="c1">#---------------------------END OF ILLUMINATION COMPUTATION---------------------------</span>

<span class="c1">#---------------------------GENERATE LED_schedule_sun.csv---------------------------</span>

<span class="c1"># scale the predicted illuminance to an intensity fraction by dividing it by the theoretical_max</span>
<span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">adjusted_twilight_sun</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">theoretical_max</span>

<span class="c1"># To simulate realistic color change according to the sun altitude, create curve functions for each RGBW:</span>
<span class="c1"># Make a table of sun&#39;s altitude ~ LED intensity fraction for each RGBW</span>
<span class="n">color_change_matrix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">matrix</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0.08</span><span class="p">,</span><span class="w"> </span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="m">0.4</span><span class="p">,</span>
<span class="w">                                </span><span class="m">42</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0.08</span><span class="p">,</span><span class="w"> </span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="m">0.4</span><span class="p">,</span>
<span class="w">                                </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0.08</span><span class="p">,</span><span class="w"> </span><span class="m">0.46</span><span class="p">,</span><span class="w"> </span><span class="m">0.26</span><span class="p">,</span>
<span class="w">                                </span><span class="m">6</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0.1</span><span class="p">,</span><span class="w"> </span><span class="m">0.4</span><span class="p">,</span><span class="w"> </span><span class="m">0.2</span><span class="p">,</span>
<span class="w">                                </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">0.16</span><span class="p">,</span><span class="w"> </span><span class="m">0.34</span><span class="p">,</span><span class="w"> </span><span class="m">0.12</span><span class="p">,</span>
<span class="w">                                </span><span class="m">-2</span><span class="p">,</span><span class="w"> </span><span class="m">0.99</span><span class="p">,</span><span class="w"> </span><span class="m">0.3</span><span class="p">,</span><span class="w"> </span><span class="m">0.34</span><span class="p">,</span><span class="w"> </span><span class="m">0.13</span><span class="p">,</span>
<span class="w">                                </span><span class="m">-4</span><span class="p">,</span><span class="w"> </span><span class="m">0.95</span><span class="p">,</span><span class="w"> </span><span class="m">0.4</span><span class="p">,</span><span class="w"> </span><span class="m">0.38</span><span class="p">,</span><span class="w"> </span><span class="m">0.18</span><span class="p">,</span>
<span class="w">                                </span><span class="m">-6.5</span><span class="p">,</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w"> </span><span class="m">0.15</span><span class="p">,</span><span class="w"> </span><span class="m">0.7</span><span class="p">,</span><span class="w"> </span><span class="m">0.9</span><span class="p">,</span>
<span class="w">                                </span><span class="m">-18</span><span class="p">,</span><span class="w"> </span><span class="m">0.6</span><span class="p">,</span><span class="w"> </span><span class="m">0.08</span><span class="p">,</span><span class="w"> </span><span class="m">0.8</span><span class="p">,</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">5</span><span class="p">,</span><span class="w"> </span><span class="n">byrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>

<span class="nf">colnames</span><span class="p">(</span><span class="n">color_change_matrix</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;sun_altitude&quot;</span><span class="p">,</span><span class="s">&quot;white&quot;</span><span class="p">,</span><span class="s">&quot;red&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">)</span>
<span class="n">color_change_matrix</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as.data.frame</span><span class="p">(</span><span class="n">color_change_matrix</span><span class="p">)</span>

<span class="n">time_interval</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">seq</span><span class="p">(</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="nf">nrow</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">),</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="n">color_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">data.frame</span><span class="p">(</span><span class="nf">matrix</span><span class="p">(</span><span class="n">ncol</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">nrow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">nrow</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">)))</span>
<span class="nf">colnames</span><span class="p">(</span><span class="n">color_table</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="s">&quot;x&quot;</span><span class="p">)</span>

<span class="c1"># Fit a smooth spline curve to the table values</span>
<span class="c1"># (!) Remove commenting in the next 15 lines (plot &amp; points) if you want to see how the LED color changes according sun altitude:</span>
<span class="n">white_curve</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ss</span><span class="p">(</span><span class="n">color_change_matrix</span><span class="o">$</span><span class="n">sun_altitude</span><span class="p">,</span><span class="w"> </span><span class="n">color_change_matrix</span><span class="o">$</span><span class="n">white</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="c1">#plot(white_curve, ylim = c(0, 1), xlab = &quot;sun_altitude&quot;, ylab = &quot;led intensity&quot;, main = &quot;color curve for white&quot;)</span>
<span class="c1">#points(color_change_matrix$sun_altitude, color_change_matrix$white)</span>

<span class="n">red_curve</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ss</span><span class="p">(</span><span class="n">color_change_matrix</span><span class="o">$</span><span class="n">sun_altitude</span><span class="p">,</span><span class="w"> </span><span class="n">color_change_matrix</span><span class="o">$</span><span class="n">red</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="c1">#plot(red_curve, ylim = c(0, 1), xlab = &quot;sun_altitude&quot;, ylab = &quot;led intensity&quot;, main = &quot;color curve for red&quot;)</span>
<span class="c1">#points(color_change_matrix$sun_altitude, color_change_matrix$red)</span>

<span class="n">green_curve</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ss</span><span class="p">(</span><span class="n">color_change_matrix</span><span class="o">$</span><span class="n">sun_altitude</span><span class="p">,</span><span class="w"> </span><span class="n">color_change_matrix</span><span class="o">$</span><span class="n">green</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="c1">#plot(green_curve, ylim = c(0, 1), xlab = &quot;sun_altitude&quot;, ylab = &quot;led intensity&quot;, main = &quot;color curve for green&quot;)</span>
<span class="c1">#points(color_change_matrix$sun_altitude, color_change_matrix$green)</span>

<span class="n">blue_curve</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ss</span><span class="p">(</span><span class="n">color_change_matrix</span><span class="o">$</span><span class="n">sun_altitude</span><span class="p">,</span><span class="w"> </span><span class="n">color_change_matrix</span><span class="o">$</span><span class="n">blue</span><span class="p">,</span><span class="w"> </span><span class="n">df</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">8</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span>
<span class="c1">#plot(blue_curve, ylim = c(0, 1), xlab = &quot;sun_altitude&quot;, ylab = &quot;led intensity&quot;, main = &quot;color curve for blue&quot;)</span>
<span class="c1">#points(color_change_matrix$sun_altitude, color_change_matrix$blue)</span>

<span class="c1"># Create a progress bar object</span>
<span class="n">pb2</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">progress_bar</span><span class="o">$</span><span class="nf">new</span><span class="p">(</span><span class="n">total</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">length</span><span class="p">(</span><span class="n">time_interval_list</span><span class="p">))</span>

<span class="nf">if </span><span class="p">(</span><span class="n">realistic_sunlight</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nf">for </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="n">in</span><span class="w"> </span><span class="n">time_interval</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">datetime</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">datetime</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">white_curve</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sun_altitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">deriv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="p">}</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;white&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="p">}</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">white</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">color_table</span><span class="o">$</span><span class="n">white</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">red_curve</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sun_altitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">deriv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="p">}</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;red&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="p">}</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">red</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">color_table</span><span class="o">$</span><span class="n">red</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">green_curve</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sun_altitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">deriv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="p">}</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;green&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="p">}</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">green</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">color_table</span><span class="o">$</span><span class="n">green</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span><span class="n">blue_curve</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;sun_altitude&quot;</span><span class="p">]</span><span class="w"> </span><span class="p">,</span><span class="w"> </span><span class="n">deriv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">)[</span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="m">2</span><span class="p">]</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span><span class="p">}</span>
<span class="w">    </span><span class="nf">if </span><span class="p">(</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="n">color_table</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;blue&quot;</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">0</span><span class="p">}</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">blue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">round</span><span class="p">(</span><span class="n">color_table</span><span class="o">$</span><span class="n">blue</span><span class="p">,</span><span class="w"> </span><span class="n">digits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">)</span>
<span class="w">    </span><span class="n">pb2</span><span class="o">$</span><span class="nf">tick</span><span class="p">()</span><span class="w"> </span><span class="c1"># Update the progress bar</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">white_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1.0</span><span class="w"> </span>
<span class="w">    </span><span class="n">red_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1.0</span><span class="w"> </span>
<span class="w">    </span><span class="n">green_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1.0</span><span class="w"> </span>
<span class="w">    </span><span class="n">blue_fraction</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1.0</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span><span class="n">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">datetime</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">datetime</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">sun_value_table</span><span class="o">$</span><span class="n">sun_altitude</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">white</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">red</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">green</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span>
<span class="w">    </span><span class="n">color_table</span><span class="o">$</span><span class="n">blue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="m">1</span>
<span class="w">  </span><span class="p">}</span>
<span class="n">color_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">color_table</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>


<span class="c1">#Calculate the RGBW crude and fine values for the light recreation</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">temp_white_intensity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bit8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">white_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">white</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">crudewhite</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">color_table</span><span class="o">$</span><span class="n">temp_white_intensity</span><span class="p">)</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">wfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">((</span><span class="n">color_table</span><span class="o">$</span><span class="n">temp_white_intensity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">crudewhite</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diode_per_strip</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">strip_count</span><span class="p">)</span>

<span class="n">color_table</span><span class="o">$</span><span class="n">temp_red_intensity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bit8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">red_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">red</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">crudered</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">color_table</span><span class="o">$</span><span class="n">temp_red_intensity</span><span class="p">)</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">rfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">((</span><span class="n">color_table</span><span class="o">$</span><span class="n">temp_red_intensity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">crudered</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diode_per_strip</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">strip_count</span><span class="p">)</span>

<span class="n">color_table</span><span class="o">$</span><span class="n">temp_green_intensity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bit8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">green_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">green</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">crudegreen</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">color_table</span><span class="o">$</span><span class="n">temp_green_intensity</span><span class="p">)</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">gfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">((</span><span class="n">color_table</span><span class="o">$</span><span class="n">temp_green_intensity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">crudegreen</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diode_per_strip</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">strip_count</span><span class="p">)</span>

<span class="n">color_table</span><span class="o">$</span><span class="n">temp_blue_intensity</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">recreate_intensity_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">bit8</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blue_fraction</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">blue</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">crudeblue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">(</span><span class="n">color_table</span><span class="o">$</span><span class="n">temp_blue_intensity</span><span class="p">)</span>
<span class="n">color_table</span><span class="o">$</span><span class="n">bfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">floor</span><span class="p">((</span><span class="n">color_table</span><span class="o">$</span><span class="n">temp_blue_intensity</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">crudeblue</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">diode_per_strip</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">strip_count</span><span class="p">)</span>

<span class="c1">#Fill sun_value_table with LED color crude and fine values. NA converted to 0.</span>
<span class="n">sun_value_table</span><span class="o">$</span><span class="n">crudewhite</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">crudewhite</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">crudewhite</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">crudewhite</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">crudewhite</span><span class="p">))</span><span class="w"> </span>

<span class="n">sun_value_table</span><span class="o">$</span><span class="n">wfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">wfine</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">wfine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">wfine</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">wfine</span><span class="p">))</span><span class="w"> </span>

<span class="n">sun_value_table</span><span class="o">$</span><span class="n">crudered</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">crudered</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">crudered</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">crudered</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">crudered</span><span class="p">))</span><span class="w"> </span>

<span class="n">sun_value_table</span><span class="o">$</span><span class="n">rfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">rfine</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">rfine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">rfine</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">rfine</span><span class="p">))</span>

<span class="n">sun_value_table</span><span class="o">$</span><span class="n">crudegreen</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">crudegreen</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">crudegreen</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">crudegreen</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">crudegreen</span><span class="p">))</span><span class="w"> </span>

<span class="n">sun_value_table</span><span class="o">$</span><span class="n">gfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">gfine</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">gfine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">gfine</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">gfine</span><span class="p">))</span>

<span class="n">sun_value_table</span><span class="o">$</span><span class="n">crudeblue</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">crudeblue</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">crudeblue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">crudeblue</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">crudeblue</span><span class="p">))</span><span class="w"> </span>

<span class="n">sun_value_table</span><span class="o">$</span><span class="n">bfine</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="n">color_table</span><span class="o">$</span><span class="n">bfine</span>
<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">transform</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">bfine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">ifelse</span><span class="p">(</span><span class="nf">is.na</span><span class="p">(</span><span class="n">bfine</span><span class="p">),</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">bfine</span><span class="p">))</span>

<span class="n">sun_value_table</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">subset</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">select</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="nf">c</span><span class="p">(</span><span class="n">twilight</span><span class="p">,</span><span class="w"> </span><span class="n">sunlight</span><span class="p">,</span><span class="w"> </span><span class="n">raw_twilight_sun</span><span class="p">))</span>

<span class="c1"># Save twilight_sun_table csv file</span>
<span class="nf">write.csv</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="s">&quot;LED_schedule_sun.csv&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">row.names</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span>

<span class="c1"># Explanation for the columns found in LED_schedule_sunlight_twilight).csv:</span>
<span class="c1">## datetime = The datetime in a standard format that R and moonshine_sun.py can read</span>
<span class="c1">## sun_altitude = The altitude of the sun. Positive/negative value means the sun is above/below the horizon, respectively.</span>
<span class="c1">## adjusted_twilight_sun = the combined illuminance of the sunlight and twilight, capped at the theoretical_max</span>
<span class="c1">## crude and fine LED values for each RGBW = the LED values that moonshine_sun.py will use instruct the LED at the given time</span>

<span class="c1">#---------------------------Plotting Section---------------------------</span>

<span class="c1"># Plot the sunlight and twilight illuminance that will be re-created.</span>
<span class="c1"># Dark gray area depicts dark periods (true night after astronomical twilight ended).</span>
<span class="c1"># Light gray area indicate the periods of astronomical twilight.</span>

<span class="n">plot_option</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="kc">TRUE</span><span class="w"> </span><span class="c1"># (!) FALSE to turn off plotting</span>

<span class="c1"># Create a clean ggplot theme</span>
<span class="n">theme_rectangular_clean</span><span class="w"> </span><span class="o">&lt;-</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.line</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_line</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.grid.major</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.grid.minor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.border</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">(),</span>
<span class="w">        </span><span class="n">panel.background</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_blank</span><span class="p">())</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.text</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">),</span>
<span class="w">        </span><span class="n">axis.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">,</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">12</span><span class="p">))</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">plot.margin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">unit</span><span class="p">(</span><span class="nf">c</span><span class="p">(</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">,</span><span class="m">0.25</span><span class="p">),</span><span class="s">&quot;cm&quot;</span><span class="p">))</span>

<span class="c1"># Specify the time of night period and twilight period for shading</span>
<span class="n">night_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">night_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">night_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>

<span class="n">after_twilight_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="p">(</span><span class="m">-18</span><span class="p">))</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">after_twilight_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">after_twilight_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="n">time_zone</span><span class="p">)</span>

<span class="n">day_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">filter</span><span class="p">(</span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="n">sun_altitude</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m">0</span><span class="p">)</span><span class="w"> </span><span class="o">%&gt;%</span><span class="w"> </span><span class="n">dplyr</span><span class="o">::</span><span class="nf">select</span><span class="p">(</span><span class="n">datetime</span><span class="p">)</span>
<span class="n">day_time</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">as_datetime</span><span class="p">(</span><span class="n">day_time</span><span class="o">$</span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">tz</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">time_zone</span><span class="p">)</span>

<span class="c1">#Plotting</span>
<span class="n">plot_output</span><span class="w"> </span><span class="o">&lt;-</span><span class="w"> </span><span class="nf">ggplot</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">theme_rectangular_clean</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">night_time</span><span class="p">,</span><span class="w"> </span><span class="c1"># night period</span>
<span class="w">                </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">night_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">),</span>
<span class="w">                </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey88&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_rect</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">xmin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">after_twilight_time</span><span class="p">,</span><span class="w"> </span><span class="c1"># after twilight</span>
<span class="w">                </span><span class="n">xmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">after_twilight_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">dminutes</span><span class="p">(</span><span class="n">time_interval_minutes</span><span class="p">),</span>
<span class="w">                </span><span class="n">ymin</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">ymax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">Inf</span><span class="p">),</span><span class="w"> </span><span class="n">fill</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;grey80&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">alpha</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">na.rm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">TRUE</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">geom_line</span><span class="p">(</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sun_value_table</span><span class="p">,</span><span class="w"> </span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">datetime</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">adjusted_twilight_sun</span><span class="p">),</span><span class="w"> </span><span class="n">colour</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&#39;black&#39;</span><span class="p">,</span><span class="w"> </span><span class="n">linewidth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.75</span><span class="p">)</span><span class="w"> </span><span class="o">+</span>
<span class="w">  </span><span class="nf">scale_y_continuous</span><span class="p">(</span><span class="n">limits</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="m">600</span><span class="p">),</span><span class="w"> </span><span class="c1"># change the y-axis range here</span>
<span class="w">    </span><span class="n">breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="nf">seq</span><span class="p">(</span><span class="n">from</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span><span class="p">,</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">600</span><span class="p">,</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">50</span><span class="p">)))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1"># change the y-axis breaks here</span>
<span class="w">  </span><span class="nf">scale_x_datetime</span><span class="p">(</span><span class="n">date_breaks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;1 day&quot;</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1"># change the date break here for different x-axis label.</span>
<span class="w">  </span><span class="nf">theme</span><span class="p">(</span><span class="n">axis.text.x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">element_text</span><span class="p">(</span><span class="n">angle</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">90</span><span class="p">,</span><span class="w"> </span><span class="n">vjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0.5</span><span class="p">,</span><span class="w"> </span><span class="n">hjust</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="c1"># rotate date label 90 degree.</span>
<span class="w">  </span><span class="nf">labs</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;predicted ground illuminance (lx)&quot;</span><span class="p">)</span><span class="w"> </span>

<span class="n">plot_output</span>

<span class="nf">beep</span><span class="p">()</span>

<span class="c1"># To save plot, remove commenting in the next line:</span>
<span class="nf">ggsave</span><span class="p">(</span><span class="s">&quot;sunlight_twilight_output.png&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">plot_output</span><span class="p">,</span><span class="w"> </span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">4488</span><span class="p">,</span><span class="w"> </span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2400</span><span class="p">,</span><span class="w"> </span><span class="n">units</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;px&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">scale</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">,</span><span class="w"> </span><span class="n">dpi</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">450</span><span class="p">)</span>
<span class="c1">## .png can be changed to .pdf to save as a vector file.</span>
<span class="c1">## However when exporting as .pdf, the shading transparency (alpha setting) might not look right. This is a limitation of R.</span>


<span class="c1">#---------------------------END OF SCRIPT---------------------------</span>

<span class="c1"># References ---------------------------  </span>

<span class="c1"># Allen, C. W. (1976). Astrophysical quantities (3rd ed. 1973, Repr. with corrections 1976). Athelone Press.; [Distributor for] U.S.A. and Canada, Humanities Press.</span>
<span class="c1"># Austin, R. H., Phillips, B. F., &amp; Webb, D. J. (1976). A method for calculating moonlight illuminance at the earth’s surface. The Journal of Applied Ecology, 13(3), 741. https://doi.org/10.2307/2402251</span>
<span class="c1"># Buratti, B. J., Hillier, J. K., &amp; Wang, M. (1996). The lunar opposition surge: Observations by clementine. Icarus, 124(2), 490–499. https://doi.org/10.1006/icar.1996.0225</span>
<span class="c1"># Hänel, A., Posch, T., Ribas, S. J., Aubé, M., Duriscoe, D., Jechow, A., Kollath, Z., Lolkema, D. E., Moore, C., Schmidt, N., Spoelstra, H., Wuchterl, G., &amp; Kyba, C. C. M. (2018). Measuring night sky brightness: Methods and challenges. Journal of Quantitative Spectroscopy and Radiative Transfer, 205, 278–290. https://doi.org/10.1016/j.jqsrt.2017.09.008</span>
<span class="c1"># Krisciunas, K., &amp; Schaefer, B. E. (1991). A model of the brightness of moonlight. Publications of the Astronomical Society of the Pacific, 103, 1033. https://doi.org/10.1086/132921</span>
<span class="c1"># Palmer, G., &amp; Johnsen, S. (2015). Downwelling spectral irradiance during evening twilight as a function of the lunar phase. Applied Optics, 54(4), B85. https://doi.org/10.1364/AO.54.000B85</span>
<span class="c1"># Schaefer, B. E. (1990). Telescopic limiting magnitudes. Publications of the Astronomical Society of the Pacific, 102, 212. https://doi.org/10.1086/132629</span>
<span class="c1"># Seidelmann, P. K., United States Naval Observatory, &amp; Great Britain (Eds.). (1992). Explanatory supplement to the Astronomical almanac (Rev. ed.). University Science Books.</span>
</pre></div>
</div>
</section>
<section id="span-style-font-variant-small-caps-moonshinep-span-moonshine-moon-py">
<h2><span style="font-variant:small-caps;">MoonShineP</span>: <code class="docutils literal notranslate"><span class="pre">moonshine_moon.py</span></code><a class="headerlink" href="#span-style-font-variant-small-caps-moonshinep-span-moonshine-moon-py" title="Permalink to this headline">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>

<span class="kn">import</span> <span class="nn">time</span>                <span class="c1">#this library is used</span>


<span class="kn">from</span> <span class="nn">rpi_ws281x</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1">#to control the leds</span>


<span class="kn">import</span> <span class="nn">argparse</span>


<span class="kn">import</span> <span class="nn">csv</span>                <span class="c1">#work with csv files</span>


<span class="kn">import</span> <span class="nn">os</span>





<span class="c1">#-------------------------------------------------------</span>



<span class="c1"># function to clear terminal and clearing it</span>



<span class="n">LED_COUNT</span>      <span class="o">=</span> <span class="mi">288</span>     <span class="c1"># Number of LED pixels.</span>



<span class="n">LED_PIN</span>        <span class="o">=</span> <span class="mi">18</span>      <span class="c1"># GPIO pin connected to the pixels (18 uses PWM!).</span>



<span class="c1">#LED_PIN        = 10      # GPIO pin connected to the pixels (10 uses SPI /dev/spidev0.0).</span>



<span class="n">LED_FREQ_HZ</span>    <span class="o">=</span> <span class="mi">800000</span>  <span class="c1"># LED signal frequency in hertz (usually 800khz)</span>



<span class="n">LED_DMA</span>        <span class="o">=</span> <span class="mi">10</span>      <span class="c1"># DMA channel to use for generating signal (try 10)</span>



<span class="n">LED_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>    <span class="c1"># Set to 0 for darkest and 255 for brightest</span>



<span class="n">LED_INVERT</span>     <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># True to invert the signal (when using NPN transistor level shift)</span>



<span class="n">LED_CHANNEL</span>    <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># set to &#39;1&#39; for GPIOs 13, 19, 41, 45 or 53</span>



<span class="n">LED_STRIP</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">SK6812_STRIP_GRBW</span>    <span class="c1"># the GRBW order is correct for addressing the corrosponding channels on the BTF-Lighting LED strips. The order of the GRBW letters can be rearranged to accommodate another RGBW protocol.</span>





<span class="c1"># Define functions which animate LEDs in various ways.</span>







<span class="c1"># Define functions which animate LEDs in various ways.</span>


<span class="c1"># this funtion gets the current time using the time library and returns it</span>
<span class="k">def</span> <span class="nf">gettime</span><span class="p">():</span>
    <span class="c1"># epoch time</span>
    <span class="n">etime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># convert to local time</span>
    <span class="n">ltime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">etime</span><span class="p">)</span>
    <span class="c1">#return the results as separate variable in the format with two characters, for example January would be 01</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%S&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">)</span>



 <span class="c1">#return epoch time</span>
<span class="k">def</span> <span class="nf">timestart</span><span class="p">():</span>

    <span class="n">etime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">ltime</span><span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">etime</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">etime</span>


<span class="c1">#defines class Led, taking a</span>
<span class="k">class</span> <span class="nc">led</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">=</span><span class="n">r</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">=</span><span class="n">g</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">=</span><span class="n">b</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">=</span><span class="n">w</span>


<span class="c1">#print the input for a specific Led on the strip</span>
<span class="k">def</span> <span class="nf">printled</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
  <span class="c1"># opens log.txt to append</span>
  <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/home/pi/Desktop/control_moon/log.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
  <span class="c1"># this is where the data is written to the file</span>
  <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">| led &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; r &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; g &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; b &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; w &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
  <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="c1">#print the same to the terminal</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------&quot;</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| led &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; r &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; g &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; b &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; w &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------&quot;</span><span class="p">)</span>


<span class="c1">#creates a &quot;virtual strip&quot; for calculations on which leds are powered and to what brightnes</span>
<span class="k">def</span> <span class="nf">fillvstrip</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">,</span><span class="n">STRIP</span><span class="p">,</span><span class="n">rfill</span><span class="p">,</span><span class="n">rfine</span><span class="p">,</span><span class="n">gfill</span><span class="p">,</span><span class="n">gfine</span><span class="p">,</span><span class="n">bfill</span><span class="p">,</span><span class="n">bfine</span><span class="p">,</span><span class="n">wfill</span><span class="p">,</span><span class="n">wfine</span><span class="p">):</span>
<span class="c1">#all Leds in the strip are assigned the apropriate &quot;fill&quot; level, or the level out of 0-255 that each diode on each led will all be set at to begin with</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">):</span>
<span class="c1">#red diode</span>
        <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span><span class="n">rfill</span><span class="p">;</span>
<span class="c1">#green diode</span>
        <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span><span class="n">gfill</span><span class="p">;</span>
<span class="c1">#blue diode</span>
        <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="o">=</span> <span class="n">bfill</span><span class="p">;</span>
<span class="c1">#white diode</span>
        <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="o">=</span> <span class="n">wfill</span><span class="p">;</span>
<span class="c1">#variables are set to one and are used as counters for increasing the leds properly</span>
    <span class="n">rcount1</span><span class="p">,</span><span class="n">rcount2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">gcount1</span><span class="p">,</span><span class="n">gcount2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">bcount1</span><span class="p">,</span><span class="n">bcount2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span> 

    <span class="n">wcount1</span><span class="p">,</span><span class="n">wcount2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>

<span class="c1">#for every led in the range of the fine level, alter the red diode if neccisary. This would be the area of code to edit if altering the order the leds increase in brightness is neccisary</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rfine</span><span class="p">):</span>
    <span class="c1">#if index is odd number, increase brightness of the matching number led</span>
       <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1">#increase brigness by one</span>
           <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">rcount2</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">rfill</span><span class="o">+</span><span class="mi">1</span>
            <span class="c1">#increase counter</span>
           <span class="n">rcount2</span> <span class="o">+=</span><span class="mi">1</span>

       <span class="k">else</span><span class="p">:</span>
           <span class="c1">#if the index is an odd number, increase the of the leds starting from halfway down the strip.</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">int</span><span class="p">((</span><span class="n">LED_COUNT</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">rcount1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">rfill</span><span class="o">+</span><span class="mi">1</span> 
            <span class="c1">#counter</span>
            <span class="n">rcount1</span> <span class="o">+=</span><span class="mi">1</span>


<span class="c1">#for every led in the range of the fine level, alter the green diode if neccisary</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gfine</span><span class="p">):</span>
    <span class="c1">#if odd number index</span>
       <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
           <span class="c1"># increase at i</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">gcount2</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">gfill</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">gcount2</span> <span class="o">+=</span><span class="mi">1</span>

       <span class="k">else</span><span class="p">:</span>
           <span class="c1"># even index, start from halfway</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">int</span><span class="p">((</span><span class="n">LED_COUNT</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">gcount1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">gfill</span><span class="o">+</span><span class="mi">1</span> 

            <span class="n">gcount1</span> <span class="o">+=</span><span class="mi">1</span>     


<span class="c1">#for every led in the range of the fine level, alter the blue diode if neccisary</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bfine</span><span class="p">):</span>

       <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
           <span class="c1"># increase at i</span>
           <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">bcount2</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">bfill</span><span class="o">+</span><span class="mi">1</span>

           <span class="n">bcount2</span> <span class="o">+=</span><span class="mi">1</span>

       <span class="k">else</span><span class="p">:</span>
           <span class="c1"># even index, start from halfway</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">int</span><span class="p">((</span><span class="n">LED_COUNT</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">bcount1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">bfill</span><span class="o">+</span><span class="mi">1</span> 

            <span class="n">bcount1</span> <span class="o">+=</span><span class="mi">1</span>
<span class="c1">#for every led in the range of the fine level, alter the white diode if neccisary</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wfine</span><span class="p">):</span>
        <span class="c1"># if odd number index</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># increase at i</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">wcount2</span><span class="p">]</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">wfill</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">wcount2</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># even index, start from halfway</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">LED_COUNT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">wcount1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">wfill</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">wcount1</span> <span class="o">+=</span> <span class="mi">1</span>



    <span class="k">return</span> <span class="n">STRIP</span> 


<span class="c1">#takes the strip and virtual strip as parameters. prints virtual strip to real strip</span>
<span class="k">def</span> <span class="nf">colorWipe3</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">vstrip</span><span class="p">):</span>


<span class="c1">#for every LED</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">strip</span><span class="o">.</span><span class="n">numPixels</span><span class="p">()):</span>
        <span class="c1">#variable holds color made from the values found in the virtual strip</span>
        <span class="n">color</span><span class="o">=</span><span class="n">Color</span><span class="p">(</span><span class="n">vstrip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">,</span><span class="n">vstrip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">g</span><span class="p">,</span><span class="n">vstrip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">vstrip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
        <span class="c1">#Set pixel color of real led to virtual led level</span>
        <span class="n">strip</span><span class="o">.</span><span class="n">setPixelColor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="c1">#execut changes</span>
    <span class="n">strip</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



       

<span class="k">def</span> <span class="nf">clear</span><span class="p">():</span>



    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;clear&#39;</span>



    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;nt&#39;</span><span class="p">,</span> <span class="s1">&#39;dos&#39;</span><span class="p">):</span>  <span class="c1"># If Machine is running on Windows, use cls</span>



        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;cls&#39;</span>



    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>



    <span class="n">clear</span><span class="p">()</span>











<span class="c1">#funtion to report the row in which a search term in found a specific column</span>
<span class="c1">#inputs are csv file, the term being searched for, and the title of the row you are searching in</span>



<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">term</span><span class="p">):</span>


    <span class="c1">#open the csv that is passed as filename</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>


        <span class="c1">#reader variable that can be parsed</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>



        <span class="n">search</span><span class="o">=</span><span class="mi">1</span>  


        <span class="c1">#parsing through all rows in the reader</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>


            <span class="c1">#when the a value is found in the column &quot;datetime&quot;  that matches the current time which is passed as the &quot;term&quot; being searched for</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">term</span><span class="p">:</span>
                <span class="c1">#open the log</span>
                <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/home/pi/Desktop/control_moon/log.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
                <span class="c1">#print the data that is found in the csv</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;found at &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudered&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;rfine&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudegreen&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;gfine&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudeblue&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bfine&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudewhite&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wfine&#39;</span><span class="p">]))</span>
                <span class="c1">#close log</span>
                <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                                                         
                <span class="c1">#print the same to the terminal</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;found at &quot;</span><span class="p">,</span><span class="n">term</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudered&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;rfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudegreen&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;gfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudeblue&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudewhite&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wfine&#39;</span><span class="p">])</span>



                <span class="n">search</span><span class="o">=</span><span class="mi">0</span>


                <span class="c1">#returns the values found under their respective headers in the csv</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudered&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;rfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudegreen&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;gfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudeblue&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudewhite&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wfine&#39;</span><span class="p">])</span>



  



    



<span class="c1"># Main program logic follows:</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>



    <span class="c1"># Process arguments</span>



    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>



    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--clear&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;clear the display on exit&#39;</span><span class="p">)</span>



    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>







    <span class="c1"># Create NeoPixel object with appropriate configuration.</span>



    <span class="n">strip</span> <span class="o">=</span> <span class="n">Adafruit_NeoPixel</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">,</span> <span class="n">LED_PIN</span><span class="p">,</span> <span class="n">LED_FREQ_HZ</span><span class="p">,</span> <span class="n">LED_DMA</span><span class="p">,</span> <span class="n">LED_INVERT</span><span class="p">,</span> <span class="n">LED_BRIGHTNESS</span><span class="p">,</span> <span class="n">LED_CHANNEL</span><span class="p">,</span> <span class="n">LED_STRIP</span><span class="p">)</span>



    <span class="c1"># Intialize the library (must be called once before other functions).</span>



    <span class="n">strip</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>


    <span class="c1"># Initializing variables for future use</span>
    <span class="n">rfill</span><span class="p">,</span><span class="n">rfine</span><span class="p">,</span><span class="n">gfill</span><span class="p">,</span><span class="n">gfine</span><span class="p">,</span><span class="n">bfill</span><span class="p">,</span><span class="n">bfine</span><span class="p">,</span><span class="n">wfill</span><span class="p">,</span><span class="n">wfine</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

    <span class="n">vstrip</span><span class="o">=</span><span class="p">[]</span>



    <span class="c1">#in range of number of lights assigned by LED_COUNT</span>
    <span class="n">vstrip</span> <span class="o">=</span> <span class="p">[</span><span class="n">led</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">)]</span>


    <span class="c1">#assign the variable vstrip by calling fillvstrip(). this initializes the strip and assigns all power levels the value of 0</span>
    <span class="n">vstrip</span> <span class="o">=</span> <span class="n">fillvstrip</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">,</span><span class="n">vstrip</span><span class="p">,</span><span class="n">rfill</span><span class="p">,</span><span class="n">rfine</span><span class="p">,</span><span class="n">gfill</span><span class="p">,</span><span class="n">gfine</span><span class="p">,</span><span class="n">bfill</span><span class="p">,</span><span class="n">bfine</span><span class="p">,</span><span class="n">wfill</span><span class="p">,</span><span class="n">wfine</span><span class="p">)</span>



    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#clear log from last time the code was ran. if changing the name or location the log is saved to this is where you would change the address, along with all other lines that open the log</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/home/pi/Desktop/control_moon/log.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>


            <span class="c1">#get the real current time and assign appropriate variables for futute formatiing</span>
            <span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">minute</span><span class="p">,</span><span class="n">second</span><span class="o">=</span><span class="n">gettime</span><span class="p">()</span>


            <span class="c1">#this code will continue when the current time is a whole minute. this is because the data found in the csv is going to be at minute intervals</span>
            <span class="k">if</span><span class="p">(</span><span class="n">second</span><span class="o">==</span><span class="s2">&quot;00&quot;</span><span class="p">):</span>

                <span class="c1">#creates a string which is formated the same as the &quot;datetime&quot; row in the csv.</span>
                <span class="n">searcht</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">minute</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
                <span class="c1">#holds values returned by search function</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="s1">&#39;/home/pi/Desktop/control_moon/LED_schedule_moon.csv&#39;</span><span class="p">,</span> <span class="n">searcht</span><span class="p">)</span>
                <span class="c1">#if result is not null,data was found</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="c1">#assign it to its respective variable</span>
                    <span class="n">rfill</span><span class="p">,</span> <span class="n">rfine</span><span class="p">,</span> <span class="n">gfill</span><span class="p">,</span> <span class="n">gfine</span><span class="p">,</span> <span class="n">bfill</span><span class="p">,</span> <span class="n">bfine</span><span class="p">,</span> <span class="n">wfill</span><span class="p">,</span> <span class="n">wfine</span> <span class="o">=</span> <span class="n">result</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#if null</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No matching term was found in the CSV file&quot;</span><span class="p">)</span>

                <span class="c1">#casecatching for if there is a matching date time but no brightness values found at that time. this would occur when the moon is not above the horizion</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">rfill</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">rfill</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">rfine</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">rfine</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">gfill</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">gfill</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">gfine</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">gfine</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">bfill</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">bfill</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">bfine</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">bfine</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">wfill</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">wfill</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">wfine</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">wfine</span> <span class="o">=</span> <span class="mi">1</span>

                
                <span class="c1">#casting all values to int data type</span>
                <span class="n">rfill</span><span class="p">,</span> <span class="n">rfine</span><span class="p">,</span> <span class="n">gfill</span><span class="p">,</span> <span class="n">gfine</span><span class="p">,</span> <span class="n">bfill</span><span class="p">,</span> <span class="n">bfine</span><span class="p">,</span> <span class="n">wfill</span><span class="p">,</span> <span class="n">wfine</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rfill</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rfine</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">gfill</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">gfine</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">bfill</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">bfine</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">wfill</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">wfine</span><span class="p">)</span>

                



                

        

                              
                <span class="c1">#fill the virtual strip with the values found in the csv</span>
                <span class="n">vstrip</span> <span class="o">=</span> <span class="n">fillvstrip</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">,</span> <span class="n">vstrip</span><span class="p">,</span> <span class="n">rfill</span><span class="p">,</span> <span class="n">rfine</span><span class="p">,</span> <span class="n">gfill</span><span class="p">,</span> <span class="n">gfine</span><span class="p">,</span> <span class="n">bfill</span><span class="p">,</span> <span class="n">bfine</span><span class="p">,</span> <span class="n">wfill</span><span class="p">,</span> <span class="n">wfine</span><span class="p">)</span>

              




                <span class="c1">#appies changes to real strip, making it match the data stored in the virtual strip</span>
                <span class="n">colorWipe3</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">vstrip</span><span class="p">)</span>






                <span class="c1">#prints what should be displaying on the light strip for the given number of leds </span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># parameter is numer of leds from virtual strip that are printed.</span>



                    <span class="n">printled</span><span class="p">(</span><span class="n">vstrip</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>



                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">52</span><span class="p">)</span>  <span class="c1"># parameter is time in seconds the program will wait before checking the clock again</span>



            

   

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>



        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="p">:</span>



            <span class="n">colorWipe</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>






</pre></div>
</div>
</section>
<section id="span-style-font-variant-small-caps-moonshinep-span-moonshine-sun-py">
<h2><span style="font-variant:small-caps;">MoonShineP</span>: <code class="docutils literal notranslate"><span class="pre">moonshine_sun.py</span></code><a class="headerlink" href="#span-style-font-variant-small-caps-moonshinep-span-moonshine-sun-py" title="Permalink to this headline">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>

<span class="kn">import</span> <span class="nn">time</span>                <span class="c1">#this library is used</span>


<span class="kn">from</span> <span class="nn">rpi_ws281x</span> <span class="kn">import</span> <span class="o">*</span>  <span class="c1">#to control the leds</span>


<span class="kn">import</span> <span class="nn">argparse</span>


<span class="kn">import</span> <span class="nn">csv</span>                <span class="c1">#work with csv files</span>


<span class="kn">import</span> <span class="nn">os</span>





<span class="c1">#-------------------------------------------------------</span>



<span class="c1"># function to clear terminal and clearing it</span>



<span class="n">LED_COUNT</span>      <span class="o">=</span> <span class="mi">576</span>     <span class="c1"># Number of LED pixels.</span>



<span class="n">LED_PIN</span>        <span class="o">=</span> <span class="mi">21</span>      <span class="c1"># GPIO pin connected to the pixels (18 uses PWM!).</span>



<span class="c1">#LED_PIN        = 10      # GPIO pin connected to the pixels (10 uses SPI /dev/spidev0.0).</span>



<span class="n">LED_FREQ_HZ</span>    <span class="o">=</span> <span class="mi">800000</span>  <span class="c1"># LED signal frequency in hertz (usually 800khz)</span>



<span class="n">LED_DMA</span>        <span class="o">=</span> <span class="mi">10</span>      <span class="c1"># DMA channel to use for generating signal (try 10)</span>



<span class="n">LED_BRIGHTNESS</span> <span class="o">=</span> <span class="mi">255</span>    <span class="c1"># Set to 0 for darkest and 255 for brightest</span>



<span class="n">LED_INVERT</span>     <span class="o">=</span> <span class="kc">False</span>   <span class="c1"># True to invert the signal (when using NPN transistor level shift)</span>



<span class="n">LED_CHANNEL</span>    <span class="o">=</span> <span class="mi">0</span>       <span class="c1"># set to &#39;1&#39; for GPIOs 13, 19, 41, 45 or 53</span>



<span class="n">LED_STRIP</span> <span class="o">=</span> <span class="n">ws</span><span class="o">.</span><span class="n">SK6812_STRIP_GRBW</span>    <span class="c1"># the GRBW order is correct for addressing the corrosponding channels on the BTF-Lighting LED strips. The order of the GRBW letters can be rearranged to accommodate another RGBW protocol.</span>





<span class="c1"># Define functions which animate LEDs in various ways.</span>







<span class="c1"># Define functions which animate LEDs in various ways.</span>


<span class="c1"># this funtion gets the current time using the time library and returns it</span>
<span class="k">def</span> <span class="nf">gettime</span><span class="p">():</span>
    <span class="c1"># epoch time</span>
    <span class="n">etime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># convert to local time</span>
    <span class="n">ltime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">etime</span><span class="p">)</span>
    <span class="c1">#return the results as separate variable in the format with two characters, for example January would be 01</span>
    <span class="k">return</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%m&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%H&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%M&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">),</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%S&quot;</span><span class="p">,</span> <span class="n">ltime</span><span class="p">)</span>



 <span class="c1">#return epoch time</span>
<span class="k">def</span> <span class="nf">timestart</span><span class="p">():</span>

    <span class="n">etime</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">ltime</span><span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">ctime</span><span class="p">(</span><span class="n">etime</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">etime</span>


<span class="c1">#defines class Led, taking a</span>
<span class="k">class</span> <span class="nc">led</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">r</span><span class="p">,</span><span class="n">g</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">w</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">r</span><span class="o">=</span><span class="n">r</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">=</span><span class="n">g</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">=</span><span class="n">b</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">=</span><span class="n">w</span>


<span class="c1">#print the input for a specific Led on the strip</span>
<span class="k">def</span> <span class="nf">printled</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span><span class="n">i</span><span class="p">):</span>
  <span class="c1"># opens log.txt to append</span>
  <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/home/pi/Desktop/control_sun/log.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
  <span class="c1"># this is where the data is written to the file</span>
  <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">| led &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; r &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; g &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; b &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; w &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>
  <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

  <span class="c1">#print the same to the terminal</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------&quot;</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| led &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; r &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; g &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">g</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; b &#39;</span> <span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; w &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">strip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span><span class="p">)</span>

  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----------------------------&quot;</span><span class="p">)</span>


<span class="c1">#creates a &quot;virtual strip&quot; for calculations on which leds are powered and to what brightnes</span>
<span class="k">def</span> <span class="nf">fillvstrip</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">,</span><span class="n">STRIP</span><span class="p">,</span><span class="n">rfill</span><span class="p">,</span><span class="n">rfine</span><span class="p">,</span><span class="n">gfill</span><span class="p">,</span><span class="n">gfine</span><span class="p">,</span><span class="n">bfill</span><span class="p">,</span><span class="n">bfine</span><span class="p">,</span><span class="n">wfill</span><span class="p">,</span><span class="n">wfine</span><span class="p">):</span>
<span class="c1">#all Leds in the strip are assigned the apropriate &quot;fill&quot; level, or the level out of 0-255 that each diode on each led will all be set at to begin with</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">):</span>
<span class="c1">#red diode</span>
        <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span><span class="n">rfill</span><span class="p">;</span>
<span class="c1">#green diode</span>
        <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span><span class="n">gfill</span><span class="p">;</span>
<span class="c1">#blue diode</span>
        <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="o">=</span> <span class="n">bfill</span><span class="p">;</span>
<span class="c1">#white diode</span>
        <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="o">=</span> <span class="n">wfill</span><span class="p">;</span>
<span class="c1">#variables are set to one and are used as counters for increasing the leds properly</span>
    <span class="n">rcount1</span><span class="p">,</span><span class="n">rcount2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">gcount1</span><span class="p">,</span><span class="n">gcount2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>

    <span class="n">bcount1</span><span class="p">,</span><span class="n">bcount2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span> 

    <span class="n">wcount1</span><span class="p">,</span><span class="n">wcount2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span>

<span class="c1">#for every led in the range of the fine level, alter the red diode if neccisary. This would be the area of code to edit if altering the order the leds increase in brightness is neccisary</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rfine</span><span class="p">):</span>
    <span class="c1">#if index is odd number, increase brightness of the matching number led</span>
       <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="c1">#increase brigness by one</span>
           <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">rcount2</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">rfill</span><span class="o">+</span><span class="mi">1</span>
            <span class="c1">#increase counter</span>
           <span class="n">rcount2</span> <span class="o">+=</span><span class="mi">1</span>

       <span class="k">else</span><span class="p">:</span>
           <span class="c1">#if the index is an odd number, increase the of the leds starting from halfway down the strip.</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">int</span><span class="p">((</span><span class="n">LED_COUNT</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">rcount1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">r</span> <span class="o">=</span> <span class="n">rfill</span><span class="o">+</span><span class="mi">1</span> 
            <span class="c1">#counter</span>
            <span class="n">rcount1</span> <span class="o">+=</span><span class="mi">1</span>


<span class="c1">#for every led in the range of the fine level, alter the green diode if neccisary</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">gfine</span><span class="p">):</span>
    <span class="c1">#if odd number index</span>
       <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
           <span class="c1"># increase at i</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">gcount2</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">gfill</span><span class="o">+</span><span class="mi">1</span>

            <span class="n">gcount2</span> <span class="o">+=</span><span class="mi">1</span>

       <span class="k">else</span><span class="p">:</span>
           <span class="c1"># even index, start from halfway</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">int</span><span class="p">((</span><span class="n">LED_COUNT</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">gcount1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">gfill</span><span class="o">+</span><span class="mi">1</span> 

            <span class="n">gcount1</span> <span class="o">+=</span><span class="mi">1</span>     


<span class="c1">#for every led in the range of the fine level, alter the blue diode if neccisary</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bfine</span><span class="p">):</span>

       <span class="k">if</span> <span class="n">i</span><span class="o">%</span><span class="mi">2</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
           <span class="c1"># increase at i</span>
           <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">bcount2</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">bfill</span><span class="o">+</span><span class="mi">1</span>

           <span class="n">bcount2</span> <span class="o">+=</span><span class="mi">1</span>

       <span class="k">else</span><span class="p">:</span>
           <span class="c1"># even index, start from halfway</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="nb">int</span><span class="p">((</span><span class="n">LED_COUNT</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">-</span><span class="n">bcount1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">bfill</span><span class="o">+</span><span class="mi">1</span> 

            <span class="n">bcount1</span> <span class="o">+=</span><span class="mi">1</span>
<span class="c1">#for every led in the range of the fine level, alter the white diode if neccisary</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">wfine</span><span class="p">):</span>
        <span class="c1"># if odd number index</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># increase at i</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">wcount2</span><span class="p">]</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">wfill</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">wcount2</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># even index, start from halfway</span>
            <span class="n">STRIP</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="nb">int</span><span class="p">((</span><span class="n">LED_COUNT</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-</span> <span class="n">wcount1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">wfill</span> <span class="o">+</span> <span class="mi">1</span>

            <span class="n">wcount1</span> <span class="o">+=</span> <span class="mi">1</span>



    <span class="k">return</span> <span class="n">STRIP</span> 


<span class="c1">#takes the strip and virtual strip as parameters. prints virtual strip to real strip</span>
<span class="k">def</span> <span class="nf">colorWipe3</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">vstrip</span><span class="p">):</span>


<span class="c1">#for every LED</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">strip</span><span class="o">.</span><span class="n">numPixels</span><span class="p">()):</span>
        <span class="c1">#variable holds color made from the values found in the virtual strip</span>
        <span class="n">color</span><span class="o">=</span><span class="n">Color</span><span class="p">(</span><span class="n">vstrip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">r</span><span class="p">,</span><span class="n">vstrip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">g</span><span class="p">,</span><span class="n">vstrip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">b</span><span class="p">,</span><span class="n">vstrip</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">w</span><span class="p">)</span>
        <span class="c1">#Set pixel color of real led to virtual led level</span>
        <span class="n">strip</span><span class="o">.</span><span class="n">setPixelColor</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">color</span><span class="p">)</span>
    <span class="c1">#execut changes</span>
    <span class="n">strip</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>



       

<span class="k">def</span> <span class="nf">clear</span><span class="p">():</span>



    <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;clear&#39;</span>



    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;nt&#39;</span><span class="p">,</span> <span class="s1">&#39;dos&#39;</span><span class="p">):</span>  <span class="c1"># If Machine is running on Windows, use cls</span>



        <span class="n">command</span> <span class="o">=</span> <span class="s1">&#39;cls&#39;</span>



    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>



    <span class="n">clear</span><span class="p">()</span>











<span class="c1">#funtion to report the row in which a search term in found a specific column</span>
<span class="c1">#inputs are csv file, the term being searched for, and the title of the row you are searching in</span>



<span class="k">def</span> <span class="nf">search</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span><span class="n">term</span><span class="p">):</span>


    <span class="c1">#open the csv that is passed as filename</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvfile</span><span class="p">:</span>


        <span class="c1">#reader variable that can be parsed</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvfile</span><span class="p">)</span>



        <span class="n">search</span><span class="o">=</span><span class="mi">1</span>  


        <span class="c1">#parsing through all rows in the reader</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>


            <span class="c1">#when the a value is found in the column &quot;datetime&quot;  that matches the current time which is passed as the &quot;term&quot; being searched for</span>
            <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">term</span><span class="p">:</span>
                <span class="c1">#open the log</span>
                <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/home/pi/Desktop/control_sun/log.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span>
                <span class="c1">#print the data that is found in the csv</span>
                <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;found at &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">term</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudered&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;rfine&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudegreen&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;gfine&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudeblue&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bfine&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudewhite&#39;</span><span class="p">])</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wfine&#39;</span><span class="p">]))</span>
                <span class="c1">#close log</span>
                <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>                                                         
                <span class="c1">#print the same to the terminal</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;found at &quot;</span><span class="p">,</span><span class="n">term</span><span class="p">,</span><span class="s2">&quot; &quot;</span><span class="p">,</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudered&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;rfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudegreen&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;gfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudeblue&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudewhite&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wfine&#39;</span><span class="p">])</span>



                <span class="n">search</span><span class="o">=</span><span class="mi">0</span>


                <span class="c1">#returns the values found under their respective headers in the csv</span>
                <span class="k">return</span> <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudered&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;rfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudegreen&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;gfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudeblue&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;bfine&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;crudewhite&#39;</span><span class="p">],</span><span class="n">row</span><span class="p">[</span><span class="s1">&#39;wfine&#39;</span><span class="p">])</span>



  



    



<span class="c1"># Main program logic follows:</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>



    <span class="c1"># Process arguments</span>



    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>



    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;--clear&#39;</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s1">&#39;store_true&#39;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s1">&#39;clear the display on exit&#39;</span><span class="p">)</span>



    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>







    <span class="c1"># Create NeoPixel object with appropriate configuration.</span>



    <span class="n">strip</span> <span class="o">=</span> <span class="n">Adafruit_NeoPixel</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">,</span> <span class="n">LED_PIN</span><span class="p">,</span> <span class="n">LED_FREQ_HZ</span><span class="p">,</span> <span class="n">LED_DMA</span><span class="p">,</span> <span class="n">LED_INVERT</span><span class="p">,</span> <span class="n">LED_BRIGHTNESS</span><span class="p">,</span> <span class="n">LED_CHANNEL</span><span class="p">,</span> <span class="n">LED_STRIP</span><span class="p">)</span>



    <span class="c1"># Intialize the library (must be called once before other functions).</span>



    <span class="n">strip</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>


    <span class="c1"># Initializing variables for future use</span>
    <span class="n">rfill</span><span class="p">,</span><span class="n">rfine</span><span class="p">,</span><span class="n">gfill</span><span class="p">,</span><span class="n">gfine</span><span class="p">,</span><span class="n">bfill</span><span class="p">,</span><span class="n">bfine</span><span class="p">,</span><span class="n">wfill</span><span class="p">,</span><span class="n">wfine</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span>

    <span class="n">vstrip</span><span class="o">=</span><span class="p">[]</span>



    <span class="c1">#in range of number of lights assigned by LED_COUNT</span>
    <span class="n">vstrip</span> <span class="o">=</span> <span class="p">[</span><span class="n">led</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">)]</span>


    <span class="c1">#assign the variable vstrip by calling fillvstrip(). this initializes the strip and assigns all power levels the value of 0</span>
    <span class="n">vstrip</span> <span class="o">=</span> <span class="n">fillvstrip</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">,</span><span class="n">vstrip</span><span class="p">,</span><span class="n">rfill</span><span class="p">,</span><span class="n">rfine</span><span class="p">,</span><span class="n">gfill</span><span class="p">,</span><span class="n">gfine</span><span class="p">,</span><span class="n">bfill</span><span class="p">,</span><span class="n">bfine</span><span class="p">,</span><span class="n">wfill</span><span class="p">,</span><span class="n">wfine</span><span class="p">)</span>



    <span class="k">try</span><span class="p">:</span>
        <span class="c1">#clear log from last time the code was ran. if changing the name or location the log is saved to this is where you would change the address, along with all other lines that open the log</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/home/pi/Desktop/control_sun/log.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span>

        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>


            <span class="c1">#get the real current time and assign appropriate variables for futute formatiing</span>
            <span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">,</span><span class="n">hour</span><span class="p">,</span><span class="n">minute</span><span class="p">,</span><span class="n">second</span><span class="o">=</span><span class="n">gettime</span><span class="p">()</span>


            <span class="c1">#this code will continue when the current time is a whole minute. this is because the data found in the csv is going to be at minute intervals</span>
            <span class="k">if</span><span class="p">(</span><span class="n">second</span><span class="o">==</span><span class="s2">&quot;00&quot;</span><span class="p">):</span>

                <span class="c1">#creates a string which is formated the same as the &quot;datetime&quot; row in the csv.</span>
                <span class="n">searcht</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">month</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">day</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">hour</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">minute</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">second</span><span class="p">)</span>
                <span class="c1">#holds values returned by search function</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">search</span><span class="p">(</span><span class="s1">&#39;/home/pi/Desktop/control_sun/LED_schedule_sun.csv&#39;</span><span class="p">,</span> <span class="n">searcht</span><span class="p">)</span>
                <span class="c1">#if result is not null,data was found</span>
                <span class="k">if</span> <span class="n">result</span><span class="p">:</span>
                    <span class="c1">#assign it to its respective variable</span>
                    <span class="n">rfill</span><span class="p">,</span> <span class="n">rfine</span><span class="p">,</span> <span class="n">gfill</span><span class="p">,</span> <span class="n">gfine</span><span class="p">,</span> <span class="n">bfill</span><span class="p">,</span> <span class="n">bfine</span><span class="p">,</span> <span class="n">wfill</span><span class="p">,</span> <span class="n">wfine</span> <span class="o">=</span> <span class="n">result</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1">#if null</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No matching term was found in the CSV file&quot;</span><span class="p">)</span>

                <span class="c1">#casecatching for if there is a matching date time but no brightness values found at that time. this would occur when the moon is not above the horizion</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">rfill</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">rfill</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">rfine</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">rfine</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">gfill</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">gfill</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">gfine</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">gfine</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">bfill</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">bfill</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">bfine</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">bfine</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">wfill</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">wfill</span> <span class="o">=</span> <span class="mi">1</span>



                <span class="k">if</span> <span class="p">(</span><span class="n">wfine</span> <span class="o">==</span> <span class="s2">&quot;#VALUE!&quot;</span><span class="p">):</span>

                    <span class="n">wfine</span> <span class="o">=</span> <span class="mi">1</span>

                
                <span class="c1">#casting all values to int data type</span>
                <span class="n">rfill</span><span class="p">,</span> <span class="n">rfine</span><span class="p">,</span> <span class="n">gfill</span><span class="p">,</span> <span class="n">gfine</span><span class="p">,</span> <span class="n">bfill</span><span class="p">,</span> <span class="n">bfine</span><span class="p">,</span> <span class="n">wfill</span><span class="p">,</span> <span class="n">wfine</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">rfill</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">rfine</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">gfill</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">gfine</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">bfill</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">bfine</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">wfill</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">wfine</span><span class="p">)</span>

                



                

        

                              
                <span class="c1">#fill the virtual strip with the values found in the csv</span>
                <span class="n">vstrip</span> <span class="o">=</span> <span class="n">fillvstrip</span><span class="p">(</span><span class="n">LED_COUNT</span><span class="p">,</span> <span class="n">vstrip</span><span class="p">,</span> <span class="n">rfill</span><span class="p">,</span> <span class="n">rfine</span><span class="p">,</span> <span class="n">gfill</span><span class="p">,</span> <span class="n">gfine</span><span class="p">,</span> <span class="n">bfill</span><span class="p">,</span> <span class="n">bfine</span><span class="p">,</span> <span class="n">wfill</span><span class="p">,</span> <span class="n">wfine</span><span class="p">)</span>

              




                <span class="c1">#appies changes to real strip, making it match the data stored in the virtual strip</span>
                <span class="n">colorWipe3</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">vstrip</span><span class="p">)</span>






                <span class="c1">#prints what should be displaying on the light strip for the given number of leds </span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>  <span class="c1"># parameter is numer of leds from virtual strip that are printed.</span>



                    <span class="n">printled</span><span class="p">(</span><span class="n">vstrip</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>



                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">52</span><span class="p">)</span>  <span class="c1"># parameter is time in seconds the program will wait before checking the clock again</span>



            

   

    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>



        <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">clear</span><span class="p">:</span>



            <span class="n">colorWipe</span><span class="p">(</span><span class="n">strip</span><span class="p">,</span> <span class="n">Color</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>






</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="download.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Download files</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="reference.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">References</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By C. Lok Poon, Ian T. Jenks & W.G.R., Crampton. University of Central Florida.<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>
---
jupytext:
  cell_metadata_filter: -all
  formats: md:myst
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.11.5
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---
(content:luxcalculator)=
# <span style="font-variant:small-caps;">MoonSim</span>: Lux calculator

_<span style="font-variant:small-caps;">MoonSim</span>: Lux calculator_ predicts ground illuminance of moonlight in lux (lx). A basic prediction of twilight and sunlight illuminance is also included.

Download _<span style="font-variant:small-caps;">MoonSim</span>: Lux calculator_ here.

## Key features

- Accurate prediction of moonlight illuminance at any geographic location and over any time period, at user-defined intervals.
- Basic prediction of twilight and sunlight illuminance as well.
- Generates .csv table of predicted illuminance over time.
- Plot illuminance over time.

(content:luxcalculator2)=
##  Packages required
- `library(suncalc)` Calculates astronomical variables given a time and location, including moon phase, moon altitude, sun altitude, and the moon to Earth distance
- `library(dplyr)` Facilitates data wrangling
- `library(rpmodel)` Calculates atmospheric pressure at given elevation
- `library(lubridate)` Makes datetime format easier to work with
- `library(REdaS)` Converts between degree angle and radian
- `library(npreg)` Fits smoothing splines
- `library(ggplot2)` Create plots
- `library(beepr)` Makes a notification sound

    ```{tip}
    This website [R Coder](https://r-coder.com/r-tutorials/r-basics/) is a good resource for learning basic R functions. Start here if you are completely new to R and need instructions on how to load R, set the working directory, install packages and run code.
    ```
##  Workflow
Below is a basic run down of the _<span style="font-variant:small-caps;">MoonSim</span>: Lux calculator_ R code, highlighting the most important steps. There the code itself is also commented. The “(!)” symbol denotes a line where the user must enter information.

1. Set the working directory. This is where the .csv and .png plot are saved.

    ```
    setwd("/Users/lokpoon/Desktop")
    ```

2. Set the geographical location for the simulation.

    ```
    latitude <- -4.21528 # (!) Latitude in decimal degrees (e.g., -4.21528)
    longitude <- -69.94056 # (!) Longitude in decimal degrees (e.g., -69.94056)
    ```

3. Set the site elevation in m above mean sea level.

    ```
    site_elev <- 0 # (!) site elevation in meter (e.g., 0 = sea level)
    ```
    
4. Set the time zone.

    ```
    time_zone <- "EST" # (!)
    # For a list of time zone names, enter OlsonNames(tzdir = NULL) in R console
    ```

5. Set the starting date, starting time, and simulation duration in days.

    ```
    date_start <- "2022-07-26" # (!) Starting date of the simulation (YYYY-MM-DD)
    time_start <- "18:00:00" # (!) Starting date of the simulation (hh:mm:ss)
    duration_day <- 29.5 # (!) Duration of simulation in days
    ```

6. Set the simulation time interval (i.e., the temporal resolution).

    ```
    time_interval_minutes <- 1 # (!) The temporal resolution in minutes.
    ```

7. Decide whether to change the default darksky_value, a constant value that is added to moonlight illuminance for representing starlight and airglow. A moonless clear sky night illuminated only by starlight and airglow ranges 0.0006 to 0.0009 lx.

    ```
    darksky_value <- 0.0008 # (!) Range = 0.0006 to 0.0009. Default = 0.0008
    ```

8. Specify the type of illumination for the y-axis in the plot of illuminance ~ time generated by _<span style="font-variant:small-caps;">MoonSim</span>_. i.e., one of the illuminance column names shown below in step 10. 
    ```
    illuminance_type_plot <- "moon_final_lux" # (!) One of the illuminance column.
    ```
    
9. Run the computation section.
10. Save a lux_calculator_output.csv, containing the illuminance prediction over time.There are five columns of different illuminance:

    ```
    write.csv(moon_value_table,"lux_calculator_output.csv", row.names = TRUE)
    ```

    The lux_calculator_output.csv contains the following columns. We included the illuminance from the different combinations of moonlight, twilight, and sunlight, because each could be useful according to the user's application.
    
    - General outputs:
   
    ```
    datetime # The datetime in a standard format that R and lightbox.py can read
    phase_angle # the phase angle of the moon
    z_moon # zenith distance of the moon in degree angle
    distance # the moon and Earth distance in km
    sun_altitude # The altitude of the sun. Positive/negative value means the sun is above/below the horizon, respectively.
    ```
    
    - Illuminance values:
    ```
    moon_final_lux # illuminance of moonlight (plus the darksky_value)
    moon_final_lux_nighttime # illuminance of moonlight only at night (reports NA at daytime, when sun altitude > 0)
    twilight # illuminance of twilight (defined as the light when sun altitude < 0)
    sunlight # illuminance of sunlight (defined as the light when sun altitude > 0)
    total_illuminance_all # sum of moonlight, twilight, and sunlight
    sunlight_twilight # sum of sunlight and twilight
    moonlight_twilight_nighttime # illuminance of moonlight plus twilight only at night (reports NA at daytime, when sun altitude > 0)
       ```

11. Save a plot of the illuminance prediction over time, as specified in step 8.
    - Dark gray area depicts dark periods (true night after astronomical twilight ended).
    - Light gray area indicate the periods of astronomical twilight.

    ```
    ggsave("plot_output.png", plot_output, width = 4488, height = 2000, units = "px", scale = 1, dpi = 450)
    ```
    
    ```{figure} /images/one_month.png
    :name: one_month

    Plot example of moonlight ground illuminance over a month in 2022 in Leticia, Colombia using the above shown settings. Y-axis scaled with limits of 0-0.3 lx wtih breaks of 0.1 lx, to show the full range of moonlight but not sunlight.
    ```
    
11. A final section of code checks if you have any lunar eclipse events within your simulation. If there is an eclipse, the time of the eclipse will be listed. The predicted illuminance does not simulate the transient reduced in moonlight intensity of a lunar eclipse.

    ```
    # Lunar eclipse warning

    if (any(abs(moon_value_table$phase_angle) < 1.5 & moon_value_table$sun_altitude < 0)) { # eclipse defined as a moon with phase angle < 1.5 during nighttime
      print("ECLIPSE IN SIMULATION!!!")
      eclipse_list <- (abs(moon_value_table$phase_angle) < 1.5 & moon_value_table$sun_altitude < 0)
      moon_value_table[which(eclipse_list == TRUE),]
    } else {
      print("no eclipse in simulation")
    }
    ```
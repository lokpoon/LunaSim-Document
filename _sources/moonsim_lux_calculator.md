---
jupytext:
  cell_metadata_filter: -all
  formats: md:myst
  text_representation:
    extension: .md
    format_name: myst
    format_version: 0.13
    jupytext_version: 1.11.5
kernelspec:
  display_name: Python 3
  language: python
  name: python3
---
(content:luxcalculator)=
# 1. <span style="font-variant:small-caps;">MoonSim</span>: Lux calculator

_<span style="font-variant:small-caps;">MoonSim</span>: Lux calculator_ predicts ground illuminance of moonlight in lux (lx). A prediction of twilight and sunlight illuminance is also included.

Download _<span style="font-variant:small-caps;">MoonSim</span>: Lux calculator_ here.

## Key features

- Provides an accurate prediction of moonlight illuminance at any geographic location and over any time period, at user-defined intervals.
- Provides a prediction of twilight and sunlight illuminance as well.
- Generates a `.csv` table of predicted illuminance over time.
- Provides a high-resolution plot of illuminance over time.

    ```{note}
    The sunlight and twilight illuminance are predicted by the sun's altitude only, and are not intended to be highly accurate predictions of the absolute illuminance.
    ```
(content:luxcalculator2)=
##  Packages required
- library(suncalc) Calculates astronomical variables given a time and location, including moon phase, moon altitude, sun altitude, and the moon to Earth distance.
- library(dplyr) Facilitates data wrangling.
- library(rpmodel) Calculates atmospheric pressure at a given site elevation.
- library(lubridate) Makes datetime format easier to work with.
- library(REdaS) Converts between degree angle and radian.
- library(npreg) Fits smoothing splines.
- library(ggplot2) Create plots.
- library(beepr) Makes a notification sound.
- library(progress) Display a progress bar of the computation progress.

    ```{tip}
    This website [R Coder](https://r-coder.com/r-tutorials/r-basics/) is a good resource for learning basic R functions. Start here if you are completely new to R and need instructions on how to load R, set the working directory, install packages and run code.
    ```
##  Workflow
Below is a summary of the main steps required to run _<span style="font-variant:small-caps;">MoonSim</span>: Lux calculator_. The code itself is also commented. The “(!)” symbol denotes a line where the user must enter information.

1. Set the working directory. This is where the `.csv` (schedule file) and .png (illuminance ~ time) plot are saved.

    ```
    setwd("/Users/lokpoon/Desktop") # (!) 
    ```

2. Set the geographical location for the simulation.

    ```
    latitude <- -4.21528 # (!) Latitude in decimal degrees (e.g., -4.21528)
    longitude <- -69.94056 # (!) Longitude in decimal degrees (e.g., -69.94056)
    ```

3. Set the site elevation in m above mean sea level.

    ```
    site_elev <- 0 # (!) site elevation in meters (e.g., 0 = sea level)
    ```
     
    ```{tip}
    This website [dcode.fr](https://www.dcode.fr/earth-elevation) can be used to determine elevation for a specific geographical coordinate, by accessing NASA Shuttle Radar Topography Mission databases.
    ```

4. Set the time zone.

    ```
    time_zone <- "EST" # (!)
    # For a list of time zone names, enter OlsonNames(tzdir = NULL) in R console
    ```

5. Set the starting date, starting time, and simulation duration in days.

    ```
    date_start <- "2022-07-26" # (!) Starting date of the simulation (YYYY-MM-DD)
    time_start <- "18:00:00" # (!) Starting date of the simulation (hh:mm:ss)
    duration_day <- 29.5 # (!) Duration of simulation in days
    ```

6. Set the simulation time interval (i.e., the temporal resolution).

    ```
    time_interval_minutes <- 1 # (!) The temporal resolution in minutes.
    ```

7. Decide whether to change the default darksky_value, a constant that is added to moonlight illuminance for representing starlight and airglow. A moonless clear sky night illuminated only by starlight and airglow ranges 0.0006 to 0.0009 lx (Hänel et al., 2018).

    ```
    darksky_value <- 0.0008 # (!) Choose from between 0.0006 to 0.0009. Default = 0.0008
    ```

8. Specify the type of illumination for the y-axis in the plot of illuminance ~ time generated by _<span style="font-variant:small-caps;">MoonSim</span>_. I.e., one of the illuminance column names shown below in step 10. 
    
    ```
    illuminance_type_plot <- "moon_final_lux" # (!) One of the illuminance column.
    ```
    
9. Run the code in the section “START OF ILLUMINATION COMPUTATION” through to “END OF ILLUMINATION COMPUTATION”. 

10. Save a `lux_calculator_output.csv`, containing the illuminance prediction over time.There are five columns of different illuminance:

    ```
    write.csv(moon_value_table,"lux_calculator_output.csv", row.names = TRUE)
    ```

    The `lux_calculator_output.csv` contains the following columns ({numref}`moon_lux_table`). We included the illuminance from the different combinations of moonlight, twilight, and sunlight, because each could be useful according to the user's application.
    
    - General outputs:
   
    ```
    datetime # The datetime in a standard format that R and lightbox.py can read
    phase_angle # the phase angle of the moon
    fraction # the illuminated fraction of the moon
    z_moon # zenith distance of the moon in degree angle
    distance # the moon and Earth distance in km
    sun_altitude # The altitude of the sun. Positive/negative value means the sun is above/below the horizon, respectively.
    ```
    
    - Illuminance values:
    ```
    moon_final_lux # illuminance of moonlight (plus the darksky_value)
    moon_final_lux_nighttime # illuminance of moonlight only at night (reports NA at daytime, when sun altitude > 0)
    twilight # illuminance of twilight (defined as the light when sun altitude < 0)
    sunlight # illuminance of sunlight (defined as the light when sun altitude > 0)
    total_illuminance_all # sum of moonlight, twilight, and sunlight
    sunlight_twilight # sum of sunlight and twilight
    moonlight_twilight_nighttime # illuminance of moonlight plus twilight only at night (reports NA at daytime, when sun altitude > 0)
       ```
    ```{figure} /images/moon_lux_table.jpg
    :name: moon_lux_table

    Dataframe of `lux_calculator_output.csv` in R. This tabulated information is exported to a `.csv` file, which can be opened, viewed and edited in Excel, if required. Right click and select ‘Open image in new tab’ to enlarge figure.
    ```
    
11. Display a plot of the illuminance prediction over time, as specified in step 8, by running the code that starts with:
    ```
    plot_output <- ggplot() + theme_rectangular_clean + ......
    ```
    And ends with:
    ```
    plot_output
    ```

12. Save this plot to working directory ({numref}`one_month`), by running the following line of code: 
    
    ```
    ggsave("plot_output.png", plot_output, width = 4488, height = 2000, units = "px", scale = 1, dpi = 450)
    ```
    
    ```{figure} /images/one_month.png
    :name: one_month

    Plot example of moonlight ground illuminance over a month in 2022 in Leticia, Colombia using the above shown settings. Y-axis scaled with limits of 0-0.3 lx wtih breaks of 0.05 lx, to show the full range of moonlight but not sunlight. Dark gray area depicts dark periods (true night after astronomical twilight ended). Light gray area indicate the periods of astronomical twilight.
    ```
    
13. Finally, the section of code depicted below checks if you have any lunar eclipse events within your simulation.

```
if (any(abs(moon_value_table$phase_angle) < 1.5 & moon_value_table$sun_altitude < 0)) { # eclipse defined as a moon with phase angle < 1.5 during nighttime
  print("ECLIPSE IN SIMULATION!!!")
  eclipse_list <- (abs(moon_value_table$phase_angle) < 1.5 & moon_value_table$sun_altitude < 0)
  moon_value_table[which(eclipse_list == TRUE),]
} else {
  print("no eclipse in simulation")
}
```

- If there is no eclipse, a "no eclipse in simulation" message will appear in the R console after the simulation is complete.

    
- If there is an eclipse, “ECLIPSE IN SIMULATION!!!” will appear in the console. _<span style="font-variant:small-caps;">MoonSim</span>_ will also report a list of all time intervals affected by both the penumbral and umbral stages of the eclipse ({numref}`eclipse`). Note that _<span style="font-variant:small-caps;">MoonSim</span>_ does not simulate the transient reduction in illuminated fraction or moonlight illuminance during a lunar eclipse (these variables will therefore be incorrectly reported reported by _<span style="font-variant:small-caps;">MoonSim</span>_ during the event). 

    ```{figure} /images/eclipse.jpg
    :name: eclipse

    Running a _<span style="font-variant:small-caps;">MoonSim</span>_ simulation during an eclipse will return a warning message and a list of the minutes of the eclipse event.
    ```